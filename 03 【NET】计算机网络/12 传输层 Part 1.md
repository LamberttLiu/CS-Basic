#计算机网络 

# 一. 传输层概念
## 功能：
1. 进程与进程之间的逻辑通信（网络层提供主机到主机）。
2. 复用和分用
3. 传输层对收到的报文进行差错检测
4. 传输层的两种协议（TCP、UDP）

## 服务
-   从通信和信息处理的角度看，运输层向它上面的应用层提供通信服务，**它属于面向通信部分的最高层，同时也是用户功能中的最低层**。
-   当网络的边缘部分中的两个主机使用网络的核心部分的功能进行端到端的通信时，**只有位于网络边缘部分的主机的协议栈才有运输层**，而网络核心部分中的路由器在转发分组时都只用到三层（到网络层）的功能。  

![[01 传输层VS网络层 作用范围.png]]

之前所介绍的计算机网络体系结构中的物理层、数据链路层以及网络层它们共同解决了将主机通过异构网络互联起来所面临的问题，实现了主机到主机的通信。  
但实际上，在计算机网络中进行通信的真正实体是位于**通信两端主机中的进程**。  
如何为运行在不同主机上的**应用进程提供直接的通信服务**是运输层的任务，运输层协议又称为**端到端协议**。

![[02 传输层作用.png]]

“逻辑通信”是指运输层之间的通信好像是沿水平方向传送数据，但事实上，这两条数据并没有一条水平方向的物理连接，要传送的数据是沿着图中上下多次的虚线方向传送的。

- 进程Ap1与Ap4之间进行基于网络的通信，进程Ap2与Ap3之间进行基于网络的通信。
- 在运输层使用不同的端口，来对应不同的应用进程。
- 然后通过网络层及其下层来传输应用层报文，接收方的运输层通过不同的端口，将收到的应用层报文，交付给应用层中相应的应用进程。
- 这里端口并不是指看得见、摸得着的物理端口，而是指用来区分不同应用进程的标识符。

## 端到端通信
![[03 端到端通信.png]]

“主机A和主机B进行通信”实际上是指：“运行在主机A上的某个程序和运行在主机B上的另一个程序进行通信”。

> **端到端的通信是进程之间的通信**。

# 二. 运输层端口号、复用与分用的概念

## 为什么用端口号

- 运行在计算机上的进程使用**进程标识符**PID来标志。
- 因特网上的计算机并不是使用统一的操作系统，不同的操作系统(windows, Linux, Mac OS)，又使用不同格式的进程标识符。
- 为了使运行不同操作系统的计算机的应用进程之间能够进行网络通信，就必须使用统一的方法对TCP/IP体系的应用进程进行标识。

**TCP/IP体系的运输层使用端口号来区分应用层的不同应用进程。**
端口号使用16比特表示，取值范围0~65535;
- **熟知端口号**: 0~1023。  
IANA把这些端口号指派给了TCP/IP体系中最重要的一些应用协议，例如: FTP使用21/20, HTTP使用80，DNS使用53。
- **登记端口号**: 1024~49151。  
为没有熟知端口号的应用程序使用。使用这类端口号必须在IANA按照规定的手续登记，以防止重复。例如: Microsoft RDP微软远程桌面使用的端口是3389。
- **短暂端口号**: 49152~65535。  
留给客户进程选择暂时使用。  
当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用。

端口号只具有本地意义，即端口号只是为了标识本计算机应用层中的各进程，在因特网中,不同计算机中的相同端口号是没有联系的。

## 发送方的复用和接收方的分用
![[04 复用和分用.png]]

> **多个进程（这里一个端口表示一个进程）** 利用一个运输层协议（或者称为运输层接口）**发送**数据称为 **复用**。
> **多个进程（这里一个端口表示一个进程）** 利用一个运输层协议（或者称为运输层接口）**接收**时叫做 **分用**。

## TCP/IP体系的应用层常用协议所使用的运输层熟知端口号
![[05 常用端口号.png]]

## 运输层传输流程

![[06 传输DNS消息.png]]

在浏览器输入域名，回车浏览。  
然后用户PC中的DNS客户端进程会发送一个DNS查询请求报文。  
DNS查询请求报文需要使用运输层的UDP协议，首部中的源端口字段的值，在短暂端口号49151~65535中挑选一个未被占用的，用来表示DNS客户端进程。
首部中的目的端口字段的值：53，是DNS服务器端进程所使用的熟知端口号。

![[07 传输DNS消息.png]]

之后，将UDP用户数据报封装在IP数据报中，通过以太网发送给DNS服务器。

![[08 传输DNS消息.png]]

DNS服务器收到该IP数据报后，从中解封出UDP用户数据报。  
UDP首部中的目的端口号为53，这表明应将该UDP用户数据报的数据载荷部分，也就是DNS查询请求报文，交付给本服务器中的DNS服务器端进程。  
DNS服务器端进程解析DNS查询请求报文的内容，然后按其要求查找对应的IP地址。  
之后，会给用户PC发送DNS响应报文，DNS响应报文需要使用运输层的UDP协议封装成UDP用户数据报。  
其首部中的源端口字段的值设置为熟知端口号53，表明这是DNS服务器端进程所发送的UDP用户数据报，目的端口的值设置为49152，这是之前用户PC中发送DNS查询请求报文的DNS客户端进程所使用的短暂端口号。  

![[09 传输DNS消息.png]]

将UDP用户数据报封装在IP数据报中，通过以太网发送给用户PC。

![[10 传输DNS消息.png]]

用户PC收到该数据报后，从中解封出UDP用户数据报。  
UDP首部中的目的端口号为49152，这表明应将该UDP用户数据报的数据载荷部分，也就是DNS响应报文，交付给用户PC中的DNS客户端进程。  
DNS客户端进程解析DNS响应报文的内容，就可知道自己之前所请求的Web服务器的域名对应的IP地址。  
现在用户PC中的HTTP客户端进程可以向Web服务器发送HTTP请求报文（和DNS发送和接收流程差不多）。

![[11 传输DNS消息.png]]

![[12 传输DNS消息.png]]

![[13 传输DNS消息.png]]

![[14 传输DNS消息.png]]

![[15 传输DNS消息.png]]

# 三. UDP和TCP的对比

## 概念
-   **UDP** 和 **TCP** 是TCP/IP体系结构**运输层**中的两个重要协议
-   当运输层采用面向连接的 **TCP** 协议时，尽管下面的网络是不可靠的（只提供尽最大努力服务），但这种逻辑通信信道就相当于一条**全双工的可靠信道**。
-   当运输层采用无连接的 **UDP** 协议时，这种逻辑通信信道是一条**不可靠信道**。

可靠信道与不可靠信道

![[16 TCP与UDP.png]]

-   两个对等运输实体在通信时传送的数据单位叫作**运输协议数据单元** TPDU (Transport Protocol Data Unit)。
-   TCP 传送的数据单位协议是 **TCP 报文段**(segment)。
-   UDP 传送的数据单位协议是 **UDP 报文**或**用户数据报**。

![[17 无连接与面向连接.png]]

![[18 UDP与TCP对比.png]]

UDP的通信是无连接的，不需要套接字（Socket）。  
TCP是面向连接的，TCP之间的通信必须要在两个套接字（Socket）之间建立连接。

## 用户数据报协议UDP（User Datagram Protocol）
UDP 支持单播、多播以及广播。  
换句话说，UDP支持一对一，一对多，以及一对全的通信。  

![[19 UDP发送过程.png]]

UDP对应用进程交下来的报文既不合并也不拆分，而是保留这些报文的边界。换句话说，UDP是面向应用报文的。  
UDP向上层提供无连接不可靠传输服务。  

![[20 UDP的层.png]]

UDP向上层提供无连接不可靠传输服务，适用于IP电话、视频会议等实时应用。  

**UDP结构**：

![[21 UDP结构.png]]

## 传输控制协议TCP（Transmission Control Protocol）
使用TCP协议的通信双方，在进行数据传输之前，必须使用“三报文握手”建立TCP连接。  
TCP连接建立成功后，通信双方之间就好像有一条可靠的通信信道，通信双方使用这条基于TCP连接的可靠信道进行通信。  
很显然，TCP仅支持单播，也就是一对一的通信。

![[22 TCP发送过程.png]]

本图只画了一个方向的数据流，在实际网络中，基于TCP连接的两端，可以同时进行TCP报文段的发送和接收。

**发送方**
-   TCP会把应用进程交付下来的数据块看作是一连串无结构的字节流，TCP并不知道这些待传送的字节流的含义。
-   并将他们编号，并存储在自己发送缓存中。
-   TCP会根据发送策略，提取一定量的字节构建TCP报文并发送。

**接收方**
-   一方面从所接受到的TCP报文段中，取出数据载荷部分并存储在接收缓存中；
-   一方面将接收缓存中的一些字节交付给应用进程。
-   TCP不保证接收方应用进程所收到的数据块与发送方发送的数据块，具有对应大小的关系（例如，发送方应用进程交给发送方的TCP共10个数据块，但接收方的TCP可能只用了4个数据块，就把收到的字节流交付给了上层的应用进程，但接收方收到的字节流必须和发送方应用进程发出的字节流完全一样）。
-   接收方的应用进程必须有能力识别收到的字节流，把它还原成有意义的应用层数据。

![[24 TCP的层.png]]

TCP是面向字节流的，这正是TCP实现可靠传输、流量控制、以及拥塞控制的基础。

![[25 TCP结构.png]]

TCP与UDP对比。

![[26 UDP与TCP对比.png]]

