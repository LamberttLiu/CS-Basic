#计算机网络 

# 四. TCP的流量控制
## 流量控制原因
一般来说， 我们总是希望数据传输得更快一些。但如果发送方**把数据发送得过快**，接收方就可能来不及接收，这就会造成数据的丢失。
所谓**流量控制** (flow control)就是让发送方的发送速率不要太快，要让接收方来得及接收。利用**滑动窗口机制**可以很方便地在TCP连接 上实现对发送方的流量控制。
## 控制过程
![[27 TCP滑动窗口.png]]
- 阶段1：
上图主机A现在可将发送缓存中序号`1~200`的字节数据全部删除，因为已经收到了主机B对它们的累计确认。
![[28 TCP滑动窗口.png]]
- 阶段2：
上图主机A现在可将发送缓存中序号`201~500`的字节数据全部删除，因为已经收到了主机B对它们的累计确认。
![[29 TCP滑动窗口.png]]
![[30 TCP滑动窗口.png]]
- 阶段3：
上图主机A现在可将发送缓存中序号`501~600`的字节数据全部删除，因为已经收到了主机B对它们的累计确认。
![[31 TCP滑动窗口.png]]
![[32 TCP滑动窗口.png]]
- 阶段4：
上图如果零窗口探测报文在发送过程中如果丢失，还是能打破死锁局面。
因为零窗口探测报文段也有重传计时器，重传计时器超时后，零窗口探测报文段会被重传。

> **利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制**。

一方面，TCP接收方利用自己的接收窗口的大小来限制发送方发送窗口的大小。
另一方面，TCP发送方收到接收方的零窗口通知后， 应启动持续计时器。持续计时器超时后，向接收方发送零窗口探测报文。

# 五. TCP的拥塞控制




# 六. TCP超时重传时间的选择








**TCP****：面向连接的传输控制协议**
**传送之前必须建立连接，结束后释放连接，不提供广播和多播。**
**时延大、可靠传输、适用于大文件。**
**UDP****：无连接的用户数据报协议**
**传送数据不需要建立连接，收到UDP****报文也不需要给出任何确认。**
**不可靠，无连接，时延小，适用于小文件。**
**传输层的寻址和端口：**
**端口：**传输层的SAP，标识主机中的应用进程，逻辑端口/软件端口。
端口号：16比特，表示65536个种类不同的端口。
端口号
服务端使用端口号
客户端使用端口号
熟知端口号
0-1013
登记端口号
1024-49151
给最重要的一些应用程序，所有用户均知道
为没有数值端口号的应用程序使用
仅仅在客户进程使用

### [62] UDP协议
UDP在IP数据服务上增加了很少功能，即**复用分用**和**差错检测**功能。
传输层=UDP首部+报文
伪首部：**只有在计算校验和的时候才出现。**
**发送过程：**
1、填上伪首部；
2、全0填充检验和字段
3、数据部分填充部分；
4、伪首部+首部数据部分，采用二进制反码求和
5、求和反码填入校验和字段
6、去掉伪首部，发送。
**接收端过程：**
1、填上伪首部；
2、伪首部+首部+数据部分二进制反码求和
3、结果全1无差错，否则丢弃或交给上层附上出错警告。
  

### [63] TCP协议

TDP协议：**面向连接（虚连接）**的传输协议。
每条TCP连接用于一对一，实现可靠传输，不丢不重。**提供全双工通信**。
TCP把应用程序交下来的数据看成是**一连串的字节流**。
**TCP****报文段的首部格式**
源端口、目的端口：各占用**16bit**。
序号：一个TCP连接中传送的字节流中每个字节都按照顺序编号，本字段表示本报文段所发送数据的**第一个字节的序号**。
确认号：**期望**收到对方下一个报文段的第一个数据字节的序号。若确认号**为****N**，则证明序号N-1为止的所有数据都已经确认收到。
数据偏移（首部长度）：TCP报文段的数据起始处距离TCP报文段的起始处有多远，以4B为单位。
**URG**——紧急位，优先发送
**ACK**——确认位，
PSH——推送位，
RST——复位，表明TCP；
**SYN**——同步位。**在连接请求和连接接受时为****1.**
FIN——终止位。
窗口：指接收窗口，**允许对方发送的数据量**。
检验和：
紧急指针：本报文段中，紧急数据的字节数。（仅仅当URG=1时才有意义）
  

### [64] TCP连接管理
TCP连接采用客户-服务器方式，主动发起连接建立的应用叫**客户**，被动等待连接建立的进程叫**服务器**。
**“三次握手”：**
**Round1****：客户端发送请求报文段，无应用层数据。**
**SYN=1****，seq（序号字段）=x（随机）**
**Round2****：服务器端为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，无应用层数据。**
**SYN=1****，ACK=1，seq=y（随机），ack（确认号字段）=x+1，**
**Round3****：客户为该TCP连接分配缓存和变量，冰箱服务器端返回确认的确认，可以携带数据。**
**SYN=0****，ACK=1，seq=x+1，ack=y+1。**
**TCP****的连接释放：**
“四次握手”
参与一条TCP链接 两个进程中任意一个都可以终止该链接，连接结束后，主机中的“资源”（缓存和变量）将会被释放。
**Round1****：客户端发送释放链接报文段，主动关闭TCP连接。**
**FIN=1****，seq=u。**
**Round2****：服务器端会送一个确认报文段，客户到服务器这个方向连接释放。**
**→半关闭状态。**
**ACK=1****，seq=v，ack=u+1。**
**Round3****：服务端发完数据，就发出连接释放报文段，主动关闭TCP连接。**
**FIN=1****，ACK=1，seq=w，ack=u+1。**
**Round4****：客户端会送一个确认报文段，在等待时间等待计时器设置的2MSL（最长报文段寿命）后，连接彻底关闭。**
**ACK=1****，seq=u+1，ack=w+1。**

### [65] TCP可靠传输
机制：1、校验；2、序号；3、确认；3、重传。
见滑动窗口确认部分。

### [66] TCP流量控制

TCP使用**滑动窗口机制**实现流量控制。
接收方根据自己接收缓存的大小，动态调整发送方的发送窗口大小，即接收窗口rwnd，拥塞窗口cwnd。**发送窗口大小可以动态变化。**
A→B，B：rwnd=400Byte，每个报文段100B，报文段序号初始值=1.
如果B返回给A rwnd=0的报文段丢失了，二者都陷入等待对方的状态，那么陷入死锁的局面。
TCP为每一个连接设有一个连续计时器，一旦零窗口通知，开始启动计时器。

### [67] TCP拥塞控制

与流量控制的差别：
**拥塞控制：**全局性，适用于一对多的模式；**流量控制**：针对点对点。
**接收窗口：**接收方容量；**拥塞窗口：**发送发根据估算的网络拥塞程度设置，翻译容量。 **发送窗口=Min{rwnd****，cwnd}**
**1****、慢开始；**
**2****、拥塞避免**
**Ssthresh****：慢开始门限，原始设定。**
**新的ssthresh****为原来的门限值的一半**
**3****、快重传；**
**4****、快恢复。**
**快重传，****只要收到三个冗余确认后，就执行快重传算法。**
例如：M1、M2（丢失）、M3、M4、M5……，发送端接收了3个冗余的M2期待的报文段。
**TCP Reno****版本****（发生快重传时，迅速降到一半）**

