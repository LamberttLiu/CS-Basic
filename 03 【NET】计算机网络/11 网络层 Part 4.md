#计算机网络 

# 十三. IPv4 首部格式
## 0. 各字段的作用
-   一个 IP 数据报由**首部**和**数据**两部分组成。
-   **首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。**
-   在首部的固定部分的后面是一些可选字段，其长度是可变的。

![[97 IPv4 报头.png]]  
![[97 IPv4 报头英文.png]]
## 1. 版本
占4比特，表示IP协议的版本。  
通信双方使用的IP协议的版本必须一致。目前广泛使用的IP协议版本号为4 (即IPv4)。

## 2. 首部长度
占4比特，表示IP数据报首部的长度。该字段的取值以4字节为单位。
- 最小十进制取值为5，表示IP数据报首部只有20字节固定部分；一个单位为4字节比如这$4 * 5 = 20$字节。
- 最大十进制取值为15，$4 * 15 = 60$，表示IP数据报首部包含20字节固定部分和最大40字节可变部分。

## 3. 区分服务
占8比特，用来获得更好的服务。  
该字段在旧标准中叫作服务类型，但实际上一直没有被使用过。1998年，因特网工程任务组IETF把这个字段改名为区分服务。  
利用该字段的不同数值可提供不同等级的服务质量。只有在使用区分服务时，该字段才起作用。一般情况下都不使用该字段。

## 4. 总长度
占16比特，表示IP数据报的总长度（首部+数据载荷）。最大取值为十进制的65535，以字节为单位。  
![[98 IPv4 报头.png]]  
【举例】  
首部长度： $(0101)_2×4=5×4=20(字节)$  
总长度：$(00000111111100)_2 = 1020 (字节)$  
数据载荷长度=总长度-首部长度 = $1020 - 20= 1000 (字节)$

## 5. 标识
![[99 数据分片.png]]  
占16比特，属于同一个数据报的各分片数据报应该具有相同的标识。  
IP软件维持一个计数器， 每产生一个数据报,计数器值加1，并将此值赋给标识字段。

## 6. 标志
占3比特，各比特含义如下：  
- **MF位:**  1表示“后面还有分片”；0表示“这是最后一个分片"。
- **DF位**:   1表示不允许分片；0表示允许分片。
- **保留位**: 必须为0。

## 7. 片偏移
占13比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位。  
片偏移以8个字节为单位。  
![[101 数据分片.png]]

​ 现在假定分片2的IP数据报经过某个网络时还需要进行分片：  
![[102 数据再分片.png]]

## 8. 生存时间TTL
占8比特，最初以秒为单位。  
一开始定义最大生存周期为255秒；路由器转发IP数据报时，将IP数据报首部中的该字段的值减去IP数据报在本路由器上所耗费的时间，若不为0就转发，否则就丢弃。  
现在再实际上，以“跳数”为单位，路由器转发IP数据报时,将IP数据报首部中的该字段的值减1，若不为0就转发，否则就丢弃。  
![[103 生存时间TTL.png]]  
【举例】**生存时间TTL字段的作用一防止IP数据报在网络中永久兜圈**。  
![[104 路由环路问题.png]]

## 9. 协议
![[105 协议位置.png]]  
占8比特，指明IPv4数据报的数据部分是何种协议数据单元。常用的一些协议和相应的协议字段值如下。  
![[106 常见协议.png]]

## 10. 首部检验和
占16比特，用来检测首部在传输过程中是否出现差错。比CRC检验码简单，称为因特网检验和。  
IP数据报每经过一个路由器，路由器都要重新计算首部检验和，因为某些字段(生存时间、标志、片偏移等)的取值可能发生变化。  
由于**IP层本身并不提供可靠传输的服务**，并且计算首部校验和是一项耗时的操作，因此在IPv6中，路由器不再计算首部校验和，从而更快转发IP数据报。

## 11. 源IP地址和目的IP地址
各占32比特，用来填写发送该IP数据报的源主机的IP地址和接收该IP数据报的目的主机的IP地址。  
![[107 srcIP dstIP.png]]

## 12. 可选字段
长度从1个字节到40个字节不等。用来支持排错、测量及安全等措施。  
可选字段增加了IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。
这就增加了每一个路由器处理IP数据报的开销。**实际上可选字段很少被使用**。

## 13. 填充字段
确保首部长度为4字节的整数倍。使用全0进行填充。

> **IP数据报的首部长度一定是4字节的整数倍**

因为首部中的可选字段的长度从1个字节到40个字节不等，那么，当20字节的固定部分加上1到40个字节长度不等的可变部分，**会造成首部长度不是4字节整数倍时，就用取值为全0的填充字段填充相应个字节**，以确保IP数据报的首部长度是4字节的整数倍。

# 十四.  网际控制报文协议ICMP
## 概念
架构IP网络时需要特别注意两点：
-   确认网络是否正常工作；
-   遇到异常时进行问题诊断。

**而ICMP就是实现这些问题的协议**
ICMP的主要功能包括：
-   确认IP包是否成功送达目标地址；
-   通知在发送过程当中IP包被废弃的具体原因；
-   改善网络设置等。

**有了这些功能以后，就可以获得网络是否正常，设置是否有误以及设备有何异常等信息，从而便于进行网络上的问题诊断**。
1. 为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP(Internet Control Message Protocol)。
2. 主机或路由器使用ICMP来发送**差错报告报文**和**询问报文**。
3. ICMP报文被**封装在IP数据报**中发送。
4. ICMP差错报告报文共有以下五种：
	1. 终点不可达；
	2. 源点抑制；
	3. 时间超过；
	4. 参数问题；
	5. 改变路由(重定向)。

## 两种常用的ICMP询问报文
1. **回送请求和回答**
ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。
收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来**测试目的站是否可达**及了解其有关状态。
2. **时间戳请求和回答**
ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间。
在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。这种询问报文用来**进行时钟同步和测量时间**。

> **ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。**

ICMP 报文的格式  
![[108 ICMP报文格式.png]]

## ICMP差错报告报文
1. 终点不可达；
当路由器或主机不能交付数据报时，就向源点发送**终点不可达报文**。  
具体可再根据ICMP的代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未知等13种错误。

![[109 重点不可达.png]]

2. 源点抑制；
当路由器或主机由于拥塞而丢弃数据报时,就向源点发送源点抑制报文,使源点知道应当把数据报的发送速率放慢。

![[110 源点抑制.png]]

3. 时间超过；
当路由器收到一个目的IP地址不是自己的IP数据报，会将其生存时间TTL字段的值减1。  
若结果不为0，则将该IP数据报转发出去；若结果为0,除丢弃该IP数据报外，还要向源点发送时间超过报文。

![[111 时间超过.png]]

另外，当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，也会向源点发送时间超过报文。

![[112 时间超过.png]]  

4. 参数问题；
口当路由器或目的主机收到IP数据报后,根据其首部中的检验和字段发现首部在传输过程中出现了误码，就丢弃该数据报，并向源点发送参数问题报文。

![[113 参数问题.png]]

5. 改变路由(重定向)。
路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

![[114 改变路由.png]]

## 不应发送ICMP差错报告报文情况
以下情况不应发送ICMP差错报告报文:
- 对ICMP差错报告报文不再发送ICMP差错报告报文。
- 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。
- 对具有多播地址的数据报都不发送ICMP差错报告报文。
- 对具有特殊地址(如127.0.0.0或0.0.0.0) 的数据报不发送ICMP差错报告报文。

## ICMP应用举例
1. 分组网间探测PING（Packet InterNet Groper）
- 用来测试主机或路由器间的连通性；
- 应用层直接使用网际层的ICMP (没有通过运输层的TCP或UDP)；
- 使用ICMP回送请求和回答报文。

2. 跟踪路由（traceroute）
测试从源IP到目的IP经过了哪些路由。

![[115 tracert.png]]

实现原理：

![[116 tracert 原理.png]]  
![[117 tracert 原理.png]]  
![[118 tracert 原理.png]]  


# 十五. 虚拟专用网VPN与网络地址转换NAT
## 虚拟专用网VPN（Virtual Private Network）
-   由于 **IP 地址的紧缺**，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。
-   考虑到**互联网并不很安全**，一个机构内也并不需要把所有的主机接入到外部的互联网。
-   假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在**机构内部使用**的计算机就可以由本机构**自行分配其 IP 地址**。

![[119 VPN.png]]

利用公用的因特网作为本机构各专用网之间的通信载体，这样的专用网又称为**虚拟专用网**。
由于IPv4地址的紧缺，一个机构能够申请到的IPv4地址数量往往远小于本机构所拥有的主
机数量。
因此，虚拟专用网中的各主机所分配的地址应该是本机构可自由分配的专用地址，而不是需要申请的、在因特网上使用的公有地址。

![[120 私有地址块.png]]  
![[121 VPN.png]]

- **私有地址**只能用于一个机构的内部通信，而不能用于和因特网上的主机通信。
	- 私有地址只能用作本地地址而不能用作全球地址；
	- 因特网中所有路由器对目的地址是私有地址的IP数据报一律不进行转发。

**本地地址与全球地址**
 -   **本地地址**——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。
-   **全球地址**——全球唯一的 IP 地址，必须向互联网的管理机构申请。
-   **问题**：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。

所以部门A和部门B至少需要一个 路由器具有合法的全球IP地址，这样各自的专用网才能利用公用的因特网进行通信。

![[122 因特网通信.png]]

部门A向部门B发送数据流程。

![[123 发送数据.png]]

两个专用网内的主机间发送的数据报是通过了公用的因特网，但在效果上就好像是在本机构的专用网上传送一样。  
数据报在因特网中可能要经过多个网络和路由器，但从逻辑上看，R1和R2之间好像是一条直通的点对点链路。
**因此VPN技术也被称为IP隧道技术**。

![[124 VPN管道技术.png]]

如图所示，同一机构内不同部门的内部网络所构成的虚拟专用网VPN又称为内联网VPN。  
有时一个机构的VPN需要有某些外部机构(通常就是合作伙伴)参加进来。这样的VPN就称为外联网VPN。  
在外地工作的员工需要访问公司内部的专用网络时，只要在任何地点接入到因特网，运行驻留在员工PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，即可访问专用网络中的资源。这种VPN称为远程接入VPN。  

## 网络地址转换NAT（Network Address Translation）
**背景**：  
虽然因特网采用了无分类编址方式来减缓IPv4地址空间耗尽的速度，但由于因特网用户数目的激增，特别是大量小型办公室网络和家庭网络接入因特网的需求不断增加，IPv4地址空间即将面临耗尽的危险仍然没有被解除。  
1994年提出了一种网络地址转换NAT的方法再次缓解了IPv4地址空间即将耗尽的问题。

NAT能使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源。  
![[125 NAT.png]]

使用私有地址的主机，如何才能与因特网上使用全球IP地址的主机进行通信？  
这需要在专用网络连接到因特网的路由器上安装NAT软件。  
![[126 NAT转化.png]]

专有NAT软件的路由器叫做NAT路由器。  
它至少有一个有效的外部全球IP地址。  
这样，所有使用私有地址的主机在和外界通信时，都要在NAT路由器上将其私有地址转换为全球IP地址。  

假设，使用私有地址的主机要给因特网上使用全球IP地址的另一台主机发送IP数据报。

![[127 NAT转化.png]]

因特网上的这台主机给源主机发回数据报。  
![[128 NAT转化.png]]  
当专用网中的这两台使用私有地址的主机都要给因特网使用全球地址的另一台主机发送数据报时，在NAT路由器的NAT转换表中就会产生两条记录，分别记录两个私有地址与全球地址的对应关系。  

![[129 NAT转化.png]]  
这种基本转换**存在一个问题**，如果NAT路由器具有N个全球IP地址， 那么**至多只能**有N个内网主机能够，同时和因特网上的主机通信。

【解决方法】  
由于绝大多数的网络应用都是使用运输层协议TCP或UDP来传送数据，因此可以利用运输层的端口号和IP地址-起进行转换。  
这样，用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信。这种将端口号和IP地址**一起进行转换**的技术叫作网络地址与端口号转换NAPT(Network Address and Port Translation)。

![[130 NAPT路由器.png]]

我们现在用的很多家用路由器都是这种NART路由器。

内网主机与外网主机的通信，是否能由外网主机首先发起？
答案是否定的。  
![[131 NAPT外网不可以主动发起通信.png]]

对于一些P2P网络应用，需要外网主机主动与内网主机进行通信，在通过NAT时会遇到问题，需要网络应用自己使用一些特殊的NAT穿越技术来解决问题。  
另外，由于NAT对外网屏蔽了内网主机的网络地址，能为内网的主机提供一定的安全保护。
