#计算机网络 
# 十二. MAC地址、IP地址以及ARP协议
- MAC地址是以太网的MAC子层所使用的地址，属于数据链路层。
- IP地址是TCP/IP体系结构网际层所使用的地址；
- ARP协议属于TCP/IP体系结构的网际层，其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取到设备的MAC地址；以上二者属于网际层。

尽管IP地址和ARP协议属于TCP/IP体系结构的网际层(而不属于数据链路层)，但是它们与MAC地址存在一定的关系，并且我们日常的网络应用都离不开MAC地址、IP地址以及ARP协议。
因此，我们将这三者放在一起讨论。

## MAC地址
 -   使用点对点信道的数据链路层不需要使用地址。
 -   使用广播信道的数据链路层必须使用地址来区分各主机。
![[84 MAC地址.png]]

### 广播信道的数据链路层必须使用地址（MAC）
- 当多个主机连接在同一 个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址；
- 在每个主机发送的帧中必须携带标识发送主机和接收主机的地址。由于这类地址是用于媒体接入控制MAC(Media Acess Control)，因此这类地址被称为MAC地址。
![[85 MAC地址.png]]

MAC地址一般被固化在网卡(网络适配器)的电可擦可编程只读存储器EEPROM中，因此MAC地址也
被称为硬件地址。
![[86 网卡.png]]
MAC地址有时也被称为物理地址。请注意：这并不意味着MAC地址属于网络体系结构中的物理层!
一般情况下， 用户主机会包含两个网络适配器：有线局域网适配器(有线网卡)和无线局域网适配器(无线网卡)。每个网络适配器都有-个全球唯一的MAC地址。而交换机和路由器往往拥有更多的网络接口，所以会拥有更多的MAC地址。

> **MAC地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识**。

**MAC地址又称为硬件地址或物理地址**。请注意：不要被 “物理” 二字误导认为物理地址属于物理层范畴，物理地址属于数据链路层范畴。

### IEEE 802局域网的MAC地址格式
![[87 MAC地址格式.png]]
**组织唯一标识符OUI**
-   生产网络设备的厂商，需要向IEEE的注册管理机构申请一个或多个OUI
**网络接口标识符**
-   由获得OUI的厂商自行随意分配
**EUI-48**
-   48是这个MAC地址的位数

![[88 MAC地址格式.png]]
> 对于使用EUI-48空间的应用程序，IEEE的目标寿命为100年（直到2080年），但是鼓励采用EUI-64作为替代

**关于无效的 MAC 帧**
-   数据字段的长度与长度字段的值不一致；
-   帧的长度不是整数个字节；
-   用收到的帧检验序列 FCS 查出有差错；
-   数据字段的长度不在 46 ~ 1500 字节之间。
-   有效的 MAC 帧长度为 64 ~ 1518 字节之间。

> **对于检查出的无效** **MAC** **帧就简单地丢弃。以太网不负责重传丢弃的帧。**

### IEEE 802局域网的MAC地址发送顺序
![[89 MAC地址格式.png]]

### 单播MAC地址举例
![[90 单播.png]]
主机B给主机C发送**单播帧**，主机B首先要构建该**单播帧**，**在帧首部中的目的地址字段填入主机C的MAC地址**，源地址字段填入自己的MAC地址，再加上帧首部的其他字段、数据载荷以及帧尾部，就构成了该**单播帧**。

![[91 单播.png]]
主机B将该**单播帧**发送出去，主机A和C都会收到该**单播帧**，
主机A的网卡发现该**单播帧**的目的MAC地址与自己的MAC地址不匹配，丢弃该帧。
主机C的网卡发现该**单播帧**的目的MAC地址与自己的MAC地址匹配，接受该帧。
并将该帧交给其上层处理。

### 广播MAC地址举例
![[92 广播.png]]
假设主机B要发送一个**广播帧**，主机B首先要构建该**广播帧**，**在帧首部中的目的地址字段填入广播地址**，也就是十六进制的全F，源地址字段填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该**广播帧**。
![[93 广播.png]]
主机B讲该**广播帧**发送出去，主机A和C都会收到该**广播帧**，**发现该帧首部中的目的地址字段的内容是广播地址**，就知道该帧是**广播帧**，主机A和主机C都接受该帧，并将该帧交给上层处理。

### 多播MAC地址举例
![[94 多播.png]]
假设主机A要发送**多播帧**给该**多播地址**。将该**多播地址**的左起第一个字节写成8个比特，第一个字节的最低比特位是1，这就表明该地址是**多播地址**。
快速判断地址是不是**多播地址**，就是上图所示箭头所指的第十六进制数不能整除2（1,3,5,7,9,B,D,F），则该地址是**多播地址**。
假设主机B，C和D支持多播，各用户给自己的主机配置多播组列表**如下所示**
![[95 多播.png]]
主机B属于两个多播组，主机C也属于两个多播组，而主机D不属于任何多播组。
![[96 多播.png]]
主机A首先要构建该**多播帧**，**在帧首部中的目的地址字段填入该多播地址**，源地址点填入自己的MAC地址，再加上帧首部中的其他字段、数据载荷以及帧尾部，就构成了该**多播帧**。
![[97 多播.png]]

> 主机A将该**多播帧**发送出去，主机B、C、D都会收到该**多播帧**。
> **主机B和C发现该多播帧的目的MAC地址在自己的多播组列表中**，主机B和C都会接受该帧。
> 主机D发现该**多播帧**的目的MAC地址不在自己得多播组列表中，则丢弃该**多播帧**。

> 给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址。


### 从网络体系结构看IP地址与MAC地址
![[98 从网络体系看MAC帧与IP帧.png]]

### 数据包转发过程中IP地址与MAC地址的变化情况
图上各主机和路由器各接口的IP地址和MAC地址用简单的标识符来表示。
![[99 IP与MAC地址在包转发过程中的变化.png]]
■ 数据包转发过程中源IP地址和目的IP地址保持不变;
■ 数据包转发过程中源MAC地址和目的MAC地址逐个链路 (或逐个网络)改变。
![[100 IP与MAC地址在包转发过程中的变化.png]]
![[101 IP与MAC地址在包转发过程中的变化.png]]
![[102 IP与MAC地址在包转发过程中的变化.png]]

如何从IP地址找出其对应的MAC地址？
ARP协议。

## ARP协议
如何从IP地址找出其对应的MAC地址？
ARP（地址解析协议）
![[103 ARP协议.png]]
![[104 ARP协议.png]]
当主机B要给主机C发送数据包时，会首先在自己的ARP高速缓存表中查找主机C的IP地址所对应的MAC地址，但未找到，因此，主机B需要发送ARP请求报文，来获取主机C的MAC地址。
![[105 ARP请求报文.png]]
ARP请求报文有具体的格式，上图的只是简单描述。
ARP请求报文被封装在MAC帧中发送，目的地址为广播地址。
主机B发送封装有ARP请求报文的广播帧，总线上的其他主机都能收到该广播帧。

![[106 ARP 请求报文.png]]
收到ARP请求报文的主机A和主机C会把ARP请求报文交给上层的ARP进程。
主机A发现所询问的IP地址不是自己的IP地址，因此不用理会。
主机C的发现所询问的IP地址是自己的IP地址，需要进行相应。
![[107 ARP响应报文.png]]

![[108 ARP响应报文.png]]
![[109 ARP高速缓存.png]]

动态与静态的区别：
![[110 ARP高速缓存.png]]
- 动态:  自动获取，生命周期默认为两分钟;
- 静态:  手工设置，不同操作系统下的生命周期不同，例如系统重启后不存在或系统重启后依然有效。

**ARP协议只能在一段链路或一个网络上使用，而不能跨网络使用**
![[111 使用ARP.png]]

ARP协议的使用是逐段链路进行的。

**地址解析协议ARP**
-   源主机在自己的ARP高速缓存表中查找目的主机的IP地址所对应的MAC地址，若找到了，则可以封装MAC帧进行发送；若找不到，则发送ARP请求(封装在广播MAC帧中) ;
-   目的主机收到ARP请求后，将源主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后给源主机发送ARP响应(封装在单播MAC帧中)，ARP响应中包含有目的主机的IP地址和MAC地址；
-   源主机收到ARP响应后，将目的主机的IP地址与MAC地址记录到自己的ARP高速缓存表中，然后就可以封装之前想发送的MAC帧并发送给目的主机；
-   ARP的作用范围:逐段链路或逐个网络使用；
-   除ARP请求和响应外，ARP还有其他类型的报文（例如用于检查IP地址冲突的“无故ARP、免费ARP(Gratuitous ARP)" ) ;
-   ARP没有安全验证机制， 存在ARP欺骗(攻击)问题。

> ARP表中的IP地址与MAC地址的对应关系记录，是**会定期自动删除的**，**因为IP地址与MAC地址的对应关系不是永久性的**。

# 十三. 集线器与交换机的区别
![[112 早期集线器.png]]
■  **使用双绞线和集线器HUB的星型以太网**
-   使用集线器的以太网在逻辑上仍是一个总线网，各站共享总线资源，使用的还是CSMA/CD协议；
-   集线器只工作在物理层，它的每个接口仅简单地转发比特，不进行碰撞检测(由各站的网卡检测) ;
-   集线器一般都有少量的容错能力和网络管理功能。例如，若网络中某个网卡出了故障，不停地发送帧。此时，集线器可以检测到这个问题，在内部断开与出故障网卡的连线，使整个以太网仍然能正常工作。
![[113 双绞线电缆.png]]
-   传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线。
-   采用双绞线的以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做**集线器** (hub)。
-   **集线器**是也可以看做多口中继器，每个端口都可以成为一个中继器，中继器是对减弱的信号进行放大和发送的设备
-   **集线器**的以太网在逻辑上仍是个总线网，需要使用CSMA/CD协议来协调各主机争用总线，只能工作在半双工模式，收发帧不能同时进行。

### 集线器HUB在物理层扩展以太网
**使用集线器扩展**：将多个以太网段连成更大的、多级星形结构的以太网。
![[114 碰撞域.png]]
-   **优点**
    1.  使原来属于不同碰撞域的以太网上的计算机能够进行跨碰撞域的通信。
    2.  扩大了以太网覆盖的地理范围。
-   **缺点**
    1.  碰撞域增大了，但总的吞吐量并未提高。
    2.  如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。

**碰撞域**
-   **碰撞域（collision domain）**又称为**冲突域**，是指网络中一个站点发出的帧会与其他站点发出的帧产生碰撞或冲突的那部分网络。
-   碰撞域越大，发生碰撞的概率越高。

## 以太网交换机-在数据链路层扩展以太网
**概念**
-   扩展以太网更常用的方法是在数据链路层进行。
-   早期使用**网桥**，现在使用**以太网交换机**。
![[115 网桥和交换机.png]]
**网桥**
-   网桥工作在数据链路层。
-   它根据 MAC 帧的目的地址对收到的帧进行转发和过滤。
-   当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC 地址，然后再确定将该帧转发到哪一个接口，或把它丢弃。

**交换机**
-   1990 年问世的交换式集线器 (switching hub) 可明显地提高以太网的性能。
-   交换式集线器常称为**以太网交换机** (switch) 或**第二层交换机** (L2 switch)，强调这种交换机工作在数据链路层。
-   以太网交换机实质上就是一个**多接口的网桥**。

## 集线器HUB与交换机SWITCH区别
![[116 Hub和Switch.png]]

使用**集线器**互连而成的共享总线式以太网上的某个主机，要给另一个主机发送单播帧，该单播帧会通过共享总线传输到**总线上的其他各个主机**。
使用交换机互连而成的交换式以太网上的某个主机，要给另一个主机发送单播帧，该单播帧进入交换机后，交换机会将该单播帧转发给目的主机，**而不是网络中的其他各个主机**。

![[117 以太网交换机.png]]
- 以太网交换机通常都有**多个接口**。每个接口都可以直接与一台主机或另一个以太网交换机相连。一般都工作在全双工方式。
- 以太网交换机**具有并行性**，能同时**连通多对接口**,使多对主机能同时通信，无碰撞(不使用CSMA/CD协议)。
- 以太网交换机一般都具有多种速率的接口,例如：10Mb/s、100Mb/s. 1Gb/s. 10Gb/s接口的多种组合。
- 以太网交换机工作在数据链路层（也包括物理层），它收到帧后，在帧交换表中查找帧的目的MAC地址所对应的接口号,然后通过该接口转发帧。
- 以太网交换机是一种即插即用设备，其内部的帧交换表是通过自学习算法自动地逐渐建立起来的。

- 帧的两种转发方式:
	1. 存储转发。
	2. 直通交换:采用基于硬件的交叉矩阵（交换时延非常小，但不检查帧是否右差错）。
## 以太网交换机的交换方式
-   存储转发方式
    -   把整个数据帧**先缓存**后再进行处理。
-   直通 (cut-through) 方式
    -   接收数据帧的同时就**立即按数据帧的目的 MAC 地址决定该帧的转发接口**，因而提高了帧的转发速度。
    -   **缺点**是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站。

**这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**。

对比集线器和交换机：
![[118 集线器和交换机.png]]
> 多台主机同时给另一台主机发送单播帧
> 集线器以太网：会产生碰撞，遭遇碰撞的帧会传播到总线上的各主机
> 交换机以太网：会将它们缓存起来，然后逐个转发给目的主机，不会产生碰撞
> **这个例子的前提条件是忽略ARP过程，并假设交换机的帧交换表已经学习或配置好了**

![[119 集线器 交换机.png]]


**集线器扩展以太网和交换机扩展以太网区别**
**单播**：
![[120 单播.png]]

**广播**
![[121 广播.png]]
**多个单播**
![[122 多个单播.png]]
![[123 广播域.png]]
广播域（broadcast domain）：指这样一部分网络，其中任何一台设备发出的广播通信都能被该部分网络中的所有其他设备所接收。


## 总结
![[124 集线器.png]]
![[125 交换机.png]]

![[126 独享带宽.png]]
工作在数据链路层的以太网交换机，其性能远远超过工作在物理层的集线器，而且价格并不贵，这就使得集线器逐渐被市场淘汰。