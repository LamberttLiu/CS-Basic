#计算机网络 

**前提概念：**
- **节点**——主机和路由器
- **链路**——两两节点的信息传输的物理通道
- **数据链路**——两两节点间的逻辑通道，实现控制数据传输协议的硬件和软件加到链路上，构成的数据链路
- **帧**——数据链路层的协议数据单元（PDU）

# 一. 数据链路层基本概念：
> **链路**是从一个结点到相邻结点的一段物理线路.

> **数据链路**则是在链路的基础上增加了一些必要的硬件（如网络适配器）和软件（如协议的实现）

>**数据链路层**在物理层提供服务的基础上向**网络层提供服务**，其最基本的服务是将源自网络层来的数据可靠地传输到相邻节点的目标机网络层。

数据链路层，其主要作用是**加强物理层传输原始比特流的功能**，将物理层提供的可能出错的物理连接改造成为逻辑上无差错的数据链路，使之对网络层表现为一条**无差错的链路**。

![[01 链路.png]]

**链路层基本功能：**
1. 服务网络层
2. 链路管理
3. 组帧
4. 流量控制
5. 差错控制

从层次上来看数据的流动：
![[02 数据流动.png]]
仅从数据链路层观察帧的流动：
![[03 帧流动.png]]

**局域网属于数据链路层**

局域网虽然是个网络。但我们并不把局域网放在网络层中讨论。
这是因为在网络层要讨论的是多个网络互连的问题，是讨论分组（packet）怎么从一个网络，通过路由器，转发到另一个网络。

而在同一个局域网中，分组怎么从一台主机传送到另一台主机，但并不经过路由器转发。从整个互联网来看，**局域网仍属于数据链路层**的范围。


# 二. 数据链路层需要解决的重要问题：
数据链路层属于计算机网路的低层。**数据链路层使用的信道主要有以下两种类型：**
-   点对点信道
-   广播信道

在**点对点信道**条件下，主要聚焦以下三个主要问题：
## 1. 封装成帧：
封装成帧 (framing) 就是在一段数据（IP数据报）的前后分别添加首部和尾部，然后就构成了一个帧。首部和尾部的一个重要作用就是进行帧定界。为网络层提供服务。
![[04 封装成帧.png]]

## 2. 差错控制
在传输过程中可能会产生差错，1 可能会变成 0， 而 0 也可能变成 1。
差错检测，交付过程中出现误码，帧尾具备检错码，可以增加检错判别。
![[05 帧校验.png]]

## 3. 可靠传输
接收方主机收到有误码的帧后，是不会接受该帧的，会将它丢弃
如果数据链路层向其上层提供的是不可靠服务，那么丢弃就丢弃了，不会再有更多措施
**如果数据链路层向其上层提供的是可靠服务，那就还需要其他措施，来确保接收方主机还可以重新收到被丢弃的这个帧的正确副本**
![[06 可靠传输.png]]
在**广播信道**条件下，如何确保帧准确无误地传播到接收处的？
如图所示，主机A，B，C，D，E通过一根总线进行互连，主机A要给主机C发送数据，代表帧的信号会通过总线传输到总线上的其他各主机，那么主机B，D，E如何知道所收到的帧不是发送给她们的，主机C如何知道发送的帧是发送给自己的?
![[07 数据链路层_点对点传输.png]]
可以用编址（地址）的来解决，将帧的目的地址添加在帧中一起传输：
![[08 MAC地址.png]]

那么，如何解决数据碰撞问题？
![[09 信号干扰碰撞.png]]
共享式局域网，即，为多点接入（multiple access）不可避免产生信号碰撞，以太网采用的方法是，使用CSMA/CD协议。

随着技术的发展，交换技术的成熟，在 有线（局域网）领域 使用**点对点链路**和**链路层交换机**的**交换式局域网**取代了~~共享式局域网~~，在无线局域网中仍然使用的是共享信道技术。

# 三. 封装成帧和透明传输：
## 封装成帧
在数据链路层给上层交付的协议数据单元添加帧头和帧尾，使之成为帧。
接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。
![[10 PPP帧.png]]
首部和尾部包含许多的控制信息，他们的一个重要作用：**帧定界**（确定帧的界限）。

但比不是每一种数据链路层协议的帧都包含有帧定界标志，例如下面例子：
![[11 前导码.png]]
前导码：
-   前同步码：作用是使接收方的时钟同步
-   帧开始定界符：表明其后面紧跟着的就是MAC帧

![[12 MAC帧间隔.png]]

**帧同步**：接收方应当能从接收到的二进制比特流中区分出帧的起始和终止。
组帧的四种方法：**1.字符计数法，2.字符（节）填充法，3.零比特填充法，4.违规编码法**。

1. 字符计数法：一个单位$n$个比特=1个字符+$(n-1)$个数据信息
![[13 字符计数法.png]]

2. **字符填充法**：1帧=$SOH$+帧中间数据部分+$EOT$
	如果数据部分出现了**EOT**怎么办？
	在原始数据中每一个**EOT**前面加入一个字节填充（8bit），即转义字符**ESC**。

3. **零比特填充法：**
	首部和尾部都是01111110，如果数据部分出现了01111110怎么办？
	原始数据中，每遇到5个1，就在后面添加0。接收端删除0。
4.  **违规编码法：**在曼彻斯特编码中采用“高高”“低低”违规编码做开头**。

由于字节计数法中Count字段的脆弱性（其值若有差错将导致灾难性后果）及字符填充实现
上的复杂性和不兼容性，目前较普遍使用的帧同步法是**比特填充和违规编码法**。

## 透明传输
**透明传输**是指不管所传数据是什么样的比特组合，都应当能够在链路上传送。因此，链路层就“看不见”有什么妨碍数据传输的东西。
当所传数据中的比特组合恰巧与某一个控制信息完全一样时，就必须采取适当的措施，使收方不会将这样的数据误认为是某种控制信息。这样才能保证数据链路层的传输是透明的。（类似于：Escape 转义）
![[14 解决透明传输.png]]

**解决方法**：
- 面向字节的物理链路使用**字节填充** (byte stuffing) 或**字符填充** (character stuffing)，面向比特的物理链路使用比特填充的方法实现透明传输；
-   发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面**插入一个转义字符“ESC”**(其十六进制编码是1B)；
-   接收端的数据链路层在将数据送往网络层之前删除插入的转义字符；
-   如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。

## 帧的数据部分长度
考虑差错控制等诸多方面元素，每一种数据链路层协议都统一规定，帧的数据长度最大传输单元（MTU Maximum Transfer Unit）。
![[15 MTU.png]]



# 四. 差错控制（检错编码）：
实际的通信链路都不是理想的，比特在传输过程中可能会产生差错: 1可能会变成0，而0也可能变成1。这称为比特差错。
在一 段时间内， 传输错误的比特占所传输比特总数的比率称为误码率BER(Bit Error Rate)。
使用差错检测码来检测数据在传输过程中是否产生 了比特差错，是数据链路层所要解决的重要问题之一。
![[16 差错控制.png]]

差错控制（比特错）控制方法
**检错编码——奇偶校验码、循环冗余码（CRC）
纠错编码——海明码

>注意：**数据链路层编码和物理层的数据编码与调制不同**。
>物理层编码针对的是单个比特，解决传输过程中比特的同步等问题，如曼彻斯特编码。
>而数据链路层的编码针对的是一组比特，它通过冗余码的技术实现一组二进制比特串在传输过程是否出现了差错。

## 1.    **奇偶校验码**

奇校验码：$X……$（1的个数是奇数）；奇校验码：$X……$（1的个数是偶数）；
检测能力50%，只能检查出奇数$（2n-1）$个bit错误。
![[17 奇偶校验.png]]
## 2.    **CRC冗余码**
 
规定一个除数，再加上他的余数（帧检验数列），这里采用异或运算，摩尔除法。

>**被除数**=待发送的数据+生成多项式最高次个0；
>**除数**=生成多项式各系数构成的比特串。
>**余数**=冗余码（帧检验数列）

![[18 冗余校验.png]]

【例】$G（x）=X^3+X^2+1$；生成多项式各项系数构成比特串：1101，待发送信息：101001，即计算：$$101001000÷1101=110101……1$$
![[CRC循环冗余码.png]]
因此$CRC=001$. 最终发送的数据应该是101001<u>001</u>。
在这里，采用异或运算，异或记作⊕，表示二者相同为0，相异为1。
$$1⊕1=0；            1⊕0=1；               0⊕0=0；$$

循环冗余校验 CRC 是一种检错方法，而帧校验序列 FCS 是添加在数据后面的冗余码。

# 五. 差错控制（纠错编码）
## 海明距离：
两个**合法编码**(码字)的对应比特取值不同的比特数称为这两个码字的海明距离(码距)。
一个有效编码集中,任意两个合法编码(码字)的海明距离的最小值称为该编码集的海明距离(码距)。

以三位编码：000，001，010，011，100，101，110，111这个编码系统，码距为1，因为$min\{\forall x_{1},x_{2}\}$。
变换成四位编码：0000，1001，1010，0011，1100，0101，0110，1111这个编码系统，该系统的码距是2.

## 海明码步骤
1. **确定校验码位数r**。
$$2^r ≥ m + r + 1$$
其中，**r为冗余 / 校验位，r为数据 / 信息位**。
以数据传输要发送的数据：D=1100为例，数据的位数m=4，满足不等式的最小r为3，也就是D=1100的海明码应该有4+3=7位，其中原数据4位，校验码3位。

2. **确定校验码和数据的位置**。
校验码放在序号为2n的位置，数据按序填上。

| 序号 | 7   | 6   | 5   | 4     | 3   | 2     | 1     |
| ---- | --- | --- | --- | ----- | --- | ----- | ----- |
| 值   | 1   | 1   | 0   | $x_4$ | 0   | $x_2$ | $x_1$ |

3. **求出校验码的值**

| 通配符 |     |     |     |<u>**1xx**</u>|     |<u>**x1x**</u>|<u>**xx1**</u>|
| ------ | --- | --- | --- | ----- | --- | ----- | ----- |
| 二进制 | 111 | 110 | 101 | 100   | 011 | 010   | 001   |
| 序号   | 7   | 6   | 5   | 4     | 3   | 2     | 1     |
| 值     | 1   | 1   | 0   | $x_4$ | 0   | $x_2$ | $x_1$ |
采用偶校验模式：
- 4号校验码负责4，5，6，7的校验，$x_4 = 0$ ;
- 2号校验码负责2，3，6，7的校验，$x_2 = 0$ ;
- 1号校验码负责1，3，5，7的校验，$x_1 = 1$ ;
  
因此完整海明码：
| 序号 | 7 | 6 | 5 | 4   | 3 | 2   | 1   |
| ---- | --- | --- | --- | ----- | --- | ----- | ----- |
| 值| 1 | 1| 0 |<u>**0**</u>| 0 |<u>**0**</u>|<u>**1**</u>|
传输数据为：1100001.

4. **检错和纠错**
若接收方收到的数据为11<u>1</u>0001，
**检错**：类似奇偶校验。
**纠错**：
- $x_4$ ，负责4，5，6，7的校验，即0，1，1，1；满足偶校验，因此$x_4=1$；
- $x_2$ ，负责2，3，6，7的校验，即0，0，1，1；满足偶校验，因此$x_2=0$；
- $x_1$ ，负责1，3，5，7的校验，即1，0，1，1；满足偶校验，因此$x_1=1$；
- 把三位校验码按照从高位到地位排列，$x_4x_2x_1=101$，即第5位出现错误。

