#计算机网络 
# 七. IP数据报的发送和转发过程
IP数据报的发送和转发过程包含以下两部分：
- **主机发送IP数据报**；
- **路由器转发IP数据报**。

> 为了将重点放在**TCP/IP协议栈的网际层发送和转发IP数据报**的过程上，在之后的举例中，我们**忽略使用ARP协议**来获取目的主机或路由器接口的MAC地址的过程以及以太网交换机自学习和转发帧的过程。

## 直接交付与间接交付：
![[30 主机间发送IP数据报.png]]
![[31 直接交付和间接交付.png]]
问题来了，源主机是怎样知道目的主机是否与自己在同一个网络中，是采用直接交付，还是间接交付呢？

![[32 判断用直接交付还是间接交付.png]]

【解决方式】可以通过**目的地址IP**和**源地址的子网掩码**进行**逻辑与运算**得到**目的网络地址**。

- 如果**目的网络地址**和**源网络地址** **相同**，就是**在同一个网络**中，属于**直接交付**。
- 如果**目的网络地址**和**源网络地址** **不相同**，就**不在同一个网络**中，属于**间接交付**，传输给主机所在网络的**默认网关**（就是下图中的路由器R），由默认网关帮忙转发。

![[33 默认网关.png]]
## 默认网关
那么，主机C如何知道路由器R的存在？
用户为了让本网络中的主机能和其他网络中的主机进行通信，就必须给其指定本网络的一个路由器的接口，由该路由器帮忙进行转发，**所指定的路由器**，也被称为**默认网关**。

例如，路由器的接口0的IP地址192.168.0.128做为左边网络的默认网关。
![[34 间接交付.png]]

主机A会将该IP数据报传输给自己的默认网关，也就是图中所示的路由器接口0。

路由器收到IP数据报后如何转发？
- 检查IP数据报首部是否出错：
	- 若出错，则直接丢弃该IP数据报并通告源主机；
	- 若没有出错，则进行转发。

- 根据IP数据报的目的地址在路由表中查找匹配的条目：
	- 若找到匹配的条目，则转发给条目中指示的下一跳；
	- 若找不到，则丢弃该数据报并通告源主机。

## 转发步骤
**步骤一：**
假设IP数据报首部没有出错，路由器取出**IP数据报首部各地址字段**的值。
![[35 步骤1 取出字段.png]]
**步骤二：**
接下来路由器对该IP数据报进行查表转发：
![[36 步骤2  查表转发.png]]
**步骤三：**
逐条检查路由条目，将目的地址与路由条目中的地址掩码进行**逻辑与运算**得到目的网络地址。  
然后与路由条目中的目的网络进行比较，如果相同，则这条路由条目就是匹配的路由条目，按照它的下一条指示，图中所示的也就是接口1转发该IP数据报。

![[37 步骤三 转发分组.png]]
**特例：**
路由器是隔离广播域的：
![[38 路由不转发 隔离.png]]


# 八. 静态路由配置及其可能产生的路由环路问题
## 概念
静态路由配置，是指用户或网络管理员使用路由器的相关命令给路由器人工配置路由表。
-   这种人工配置方式简单、开销小。但不能及时适应网络状态(流量、拓扑等)的变化。
-   一般只在小规模网络中采用。

使用静态路由配置可能出现以下导致产生路由环路的错误。
-   配置错误；
-   聚合了不存在的网络 ；
-   网络故障。

## 静态路由配置
![[39 默认路由.png]]
静态路由（英语：Static routing）是一种路由的方式，即路由项（routing entry）由手动配置，而非动态决定。

## 默认路由
默认路由可以被所有网络匹配，但路由匹配有优先级，默认路由是优先级最低的。
![[40 默认路由.png]]

## 特定主机路由
有时候，我们可以给路由器添加针对某个主机的特定主机路由条目，一般用于网络管理人员对网络的管理和测试。
![[41 特定主机路由.png]]

> 多条路由可选，匹配路由最具体的，**静态路由配置错误导致路由环路**。

举例
![[42 特定主机路由.png]]

假设将R2的路由表中第三条目录配置错了下一跳，这导致R2和R3之间产生了路由环路。

![[43 路由环路.png]]
## 聚合了不存在的网络而导致路由环路
正常情况：
![[44 聚合环路.png]]

## 聚合了不存在的网络而导致路由环路
![[45 聚合环路.png]]
错误情况
![[46 路由环绕.png]]


解决方法
![[47 黑洞路由.png]]

![[48 黑洞路由.png]]
黑洞路由的下一跳为`null0`，这是路由器内部的虚拟接口，IP数据报进入它后就被丢弃。

![[49 黑洞路由.png]]


![[50 黑洞路由.png]]
解决方法：
添加故障的网络为黑洞路由

![[51 黑洞路由.png]]

![[52 黑洞路由.png]]

假设，一段时间后故障网络恢复了，R1又自动地得出了其接口0的直连网络的路由条目。
针对该网络的黑洞网络会自动失效。
![[53 黑洞网络.png]]
如果又故障，则生效该网络的黑洞网络。
![[54 黑洞网络.png]]
## 总结
-   静态路由配置是指**用户或网络管理员使用路由器的相关命令给路由器人工配置路由表**：
	-    这种人工配置方式简单、开销小。但不能及时适应网络状态(流量、拓扑等)的变化。
	-    一般只在小规模网络中采用。

-   使用静态路由配置可能出现以下导致产生路由环路的错误：
	-   配置错误；
	-   聚合了不存在的网络；
	-   网络故障。

- 路由条目的类型：
	-   直连网络；
	-   静态路由(人工配置)；
	-   动态路由(路由选择协议)。

- 特殊的静态路由条目：
	-   默认路由(目的网络为0.0.0.0, 地址掩码为0.0.0.0)；
	-   特定主机路由(目的网络为特定主机的IP地址，地址掩码为255.255.255.255)；
	-   黑洞路由(下一跳为null0)。

# 九.  路由选择协议
## 静态路由选择和动态路由选择
![[55 路由选择 静态vs动态.png]]

- **静态路由选择**
	- 由人工配置的网络路由、默认路由、特定主机路由、黑洞路由等都属于静态路由。
	- 这种人工配置方式简单、开销小。
	- 但不能及时适应网络状态(流量、拓扑等)的变化。
	-  一般只在小规模网络中采用。

- **动态路由选择**
	- 路由器通过路由选择协议自动获取路由信息。
	- 比较复杂、开销比较大。
	- 能较好地适应网络状态的变化。
	- 适用于大规模网络。

因特网所采用的路由选择协议的主要特点：
- **自适应**：   动态路由选择，能较好地适应网络状态的变化。
- **分布式**：   路由器之间交换路由信息。
- **分层次**：   将整个因特网划分为许多较小的自治系统AS(Autonomous System)。


## 因特网采用分层次的路由选择协议
-   **自治系统 AS**：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。
![[56 域内 域间 路由选择.png]]

自治系统之间的路由选择简称为域间路由选择，自治系统内部的路由选择简称为域内路由选择。

![[57 内部网关和外部网关协议.png]]
域间路由选择使用外部网关协议EGP这个类别的路由选择协议，
域内路由选择使用内部网关协议IGP这个类别的路由选择协议，
**网关协议**的名称可称为**路由协议**。

**常见的路由选择协议**
![[58 常见路由选择协议.png]]
## 路由器的基本结构
路由器是一种具有多个输入端口，和输出端口的专用计算机，其任务是转发分组。
![[59 路由器构成.png]]
路由器结构可划分为两大部分：路由表和转发表。

## 分组转发部分
转发部分由三部分构成
-   **交换结构**
-   **一组输入端口**：信号从某个输入端口进入路由器。

![[60 输入端口.png]]  
物理层将信号转换成比特流，送交数据链路层处理。
![[61 输入端口.png]]  
数据链路层识别从比特流中识别出帧，去掉帧头和帧尾后，送交网络层处理。
![[62 输入端口.png]]  
如果送交网络层的分组是普通待转发的数据分组。
![[63 输入端口.png]]  
则根据分组首部中的目的地址进行查表转发。
![[64 转发表.png]]
-   若找不到匹配的转发条目，则丢弃该分组，否则，按照匹配条目中所指示的端口进行转发。
-   **一组输出端口**。
网络层更新数据分组首部中某些字段的值，例如将数据分组的生存时间减1，然后送交数据链路层进行封装。  
![[65 输出端口.png]]  
数据链路层将数据分组封装成帧，交给物理层处理。
![[66 输出端口.png]]  
-   物理层将帧看成比特流将其变换成相应的电信号进行发送。

路由器的各端口还会有**输入缓冲区**和**输出缓冲区**。
 -   **输入缓冲区**用来暂存新进入路由器但还来不及处理的分组。
 -   **输出缓冲区**用来暂存已经处理完毕但还来不及发送的分组。

![[67 路由器转发结构.png]]
**路由器的端口一般都具有输入和输出功能**，这些实例分出了输入端口和输出端口是更好演示路由基本工作过程。

## 路由选择部分
-   路由选择部分的核心构件是**路由选择处理机**，它的任务是根据所使用的路由选择协议。周期性地与其他路由器 进行路由信息的交互，来更新路由表。
-   如果送交给输入端口的网络层的分组是路由器之间交换路由信息的路由报文，则把这种分组送交给路由选择处理机。

路由选择处理机根据分组的内容来更新自己的**路由表**。
![[68 路由主要结构.png]]
**路由表与转发表对比**：
-   **路由表**，一般仅包含从目的网络到下一跳的映射，路由表需要对网络拓扑变化的计算最优化。 
![[68 路由表.png]]
-   **转发表**，是从路由表得出的，转发表的结构应当使查找过程最优化。一般仅涉及一个路由表。
![[68 转发表.png]]
路由选择处理机还会周期性地给其他路由器发送自己所知道的路由信息。


