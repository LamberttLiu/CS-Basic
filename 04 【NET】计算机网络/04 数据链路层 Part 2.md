#计算机网络 

# 六. 差错的类型

## 1. 比特差错
![[19 有线与无线 差错控制.png]]
1. 使用差错检测技术 (例如循环冗余校验CRC) ,接收方的数据链路层就可检测出帧在传输过程中是否产生了误码(比特错误)。
2. 数据链路层向上层提供的服务类型：
	1. 不可靠传输服务:仅仅丢弃有误码的帧，其他什么也不做;
	2. 可靠传输服务: 想办法实现发送端发送什么，接收端就收到什么
3. 一般情况下，有线链路的误码率比较低，为了减小开销，并不要求数据链路层向上提供可靠传输服务。即使出现了误码，可靠传输的问题由其上层处理。
4. 无线链路易受干扰， 误码率比较高，因此要求数据链路层必须向上层提供可靠传输服务。

![[20 可靠传输在数据链路层的体现.png]]

比特差错只是传输差错中的一种。
从整个计算机网络体系结构来看，传输差错还包括分组丢失、分组失序以及分组重复。

## 2. 分组丢失
路由器输入队列快满了，主动丢弃收到的分组：
![[21 分组丢失.png]]


## 3. 分组失序
数据并未按照发送顺序依次到达接收端：
![[22 分组失序.png]]


## 4. 分组重复
由于某些原因，有些分组在网络中滞留了，没有及时到达接收端，这可能会造成发送端对该分组的重发，重发的分组到达接收端，但一段时间后，滞留在网络的分组也到达了接收端，这就造成**分组重复**的传输差错。

# 七. 链路层实现可靠传输
**前提概念：**
较高的发送速度和较低的接收能力的不匹配，会造成**传输出错**，因此流量控制也是数据链路层的一项重要工作。
**注意**：
-  **链路层**  的流量控制是点对点的；
-  **传输层**  的流量控制是端到端的。
-  **链路层**  流量控制手段：接收方收不下就**不回复确认**；
-  **传输层**流量控制手段，接收端给**发送端一个窗口公告**。

## 0. 三种可靠协议
-   停止-等待协议（SW）
-   回退N帧协议（GBN）
-   选择重传协议（SR）
这三种可靠传输实现机制的基本原理并不仅限于数据链路层，可以应用到计算机网络体系结构的各层协议中。
其中，又分为后退N帧协议（GBN），选择重传协议（SR），都称之为**滑动窗口协议**。

## 1. 停止-等待协议（SW）
### 原因
底层信道出现的丢包问题——因为各种原因导致数据包的丢失。
### 前提
1、**仅考虑一方发送，一方接收；**
2、不考虑在哪一个特定层级。
### 应用
1、无差错情况（如上一节）
2、有差错情况

可能遇到的四个问题/ 差错情形
### 确认与否认
接收方收到发送方发送的DATA，确认不对将其丢弃，并发送NAK信息（Negative Acknowledgment）
![[23 Nak包.png]]
### 超时重传
![[24 超时重传.png]]
接收方收不到数据分组，就不会发送ACK或NAK。如果不采取其他措施，发送方就会直处于等待接收方 ACK或NAK的状态。
为解决该问题，可以在发送方发送完一个数据分组时，启动一个超时计时器。若到了超时计时器所设置的重传时间而发送方仍收不到接收方的任何ACK或NAK，则重传原来的数据分组，这就叫做超时重传。
一般可将重传时间选为略大于“从发送方到接收方的平均往返时间”。

### 确认丢失
![[25 确认丢失.png]]
![[26 确认丢失.png]]
为避免分组重复这种传输错误，必须给每个分组带上序号。对于停止-等待协议，由于每发送一个数据分组就停止等待，只要保证每发送一 个新的数据分组，其发送序号与上次发送的数据分组的序号不同就可以了，因此用一个比特来编号就够了。

### 确认迟到
![[27 确认迟到.png]]
注意，图中最下面那个数据分组与之前序号为0的那个数据分组不是同一个数据分组。

### 过程梳理
1. 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传。但对于误码率较高的点对点链路，为使发送方尽早重传，也可给发送方发送`NAK`分组。
2. 为了让接收方能够判断所收到的数据分组是否是重复的，需要给数据分组编号。由于停止—等待协议的停等特性，只需1个比特编号就够了，即编号0和1。
3. 为了让发送方能够判断所收到的ACK分组是否是重复的，需要给ACK分组编号,所用比特数量与数据分组编号所用比特数量一样。 
4. 数据链路层一般不会出现ACK分组迟到的情况，因此在数据链路层实现停止等待协议可以不用给ACK分组编号。
5. 超时计时器设置的重传时间应仔细选择。一般可将重传时间选为略大于"从发送方到接收方的平均往返时间”。
6. 在数据链路层点对点的往返时间比较确定，重传时间比较好设定。
7. 然而在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易。

### 信道利用率
假设收发双方之间是一条直通的信道
-   **T_D**：是发送方发送数据分组所耗费的发送时延
-   **RTT**：是收发双方之间的往返时间
-   **T_A**：是接收方发送确认分组所耗费的发送时延
T_A一般都远小于T_D，可以忽略，当RTT远大于T_D时，信道利用率会非常低

**差错1**：数据帧丢失 或者 帧出错

差错2：确认帧（ACK）丢失，或者确认帧（ACK）迟到
![[28 信道利用率.png]]
**信道利用率公式**

$$信道利用率U=\frac{T_D}{T_D+RTT+T_A}=(L/C)/T$$
其中：
L-----T时间内发送数据的bit数目；
C-----传输发送速率；
T-----周期（左分母）。
这其中$T_A$通常忽略不计。
$$信道吞吐率=信道利用率×发送方的发送速率$$

【例题】一个信道的数据传输率为4kb/s，单向传播时延为30ms，如果使停止-等待协议的信道最大利用率达到80%，要求的数据帧长度至少为多少？
$$80\% = \frac{L/4kbps}{L/4kbps+2×30ms}，解得L=960bit$$

## 2. 回退N帧协议（GBN）
在相同的时间内，使用停止-等待协议的发送方只能发送一个数据分组，而采用流水线传输的发送方，可以发送多个数据分组。
![[29 流水线传输.png]]
回退N帧协议在流水线传输的基础上，利用发送窗口来限制发送方可连续发送数据分组的个数。
1. 采用3个比特给分组编序号，即序号0~7；
2. 发送窗口的尺寸$W_{TX}$的取值: $1 < w_{TX}< 2^3 -1$，本例取$W_{TX}=5$；
3. 接收窗口的尺寸$W_{RX}$的取值: $W_{RX} = 1$。
![[30 GBN 发送对接收多对一.png]]
### 无差错情况流程
发送方将序号落在发送窗口内的0~4号数据分组，依次连续发送出去。
![[31 正常传输.png]]

他们经过互联网传输正确到达接收方，就是没有乱序和误码，接收方按序接收它们，每接收一个，接收窗口就向前滑动一个位置，并给发送方发送针对所接收分组的确认分组，在通过互联网的传输正确到达了发送方。
![[32 正常传输.png]]

### 累计确认
接收方不一定要对收到的数据分组逐个发送确认，而是可以在收到几个数据分组后(由具体实现决定)，对按序到达的最后一个数据分组发送确认。
$ACK_n$表示序号为n及以前的所有数据分组都已正确接收。
**优点**:
-   即使确认分组丢失，发送方也可能不必重传。
-   减小接收方的开销。
-   减小对网络资源的占用。
**缺点**：
-   不能向发送方及时反映出接收方已经正确接收的数据分组信息。

### 有差错情况流程
在传输数据分组时，5号数据分组出现误码，接收方通过数据分组中的检错码发现了错误。
![[33 传输异常.png]]

于是丢弃该分组，而后续到达的这剩下四个分组与接收窗口的序号不匹配。
![[34 传输异常.png]]

接收同样也不能接收它们，将它们丢弃，并对之前按序接收的最后一个数据分组进行确认，发送ACK4，**每丢弃一个数据分组，就发送一个ACK4**。
![[35 传输异常.png]]
当收到重复的ACK4时，就知道之前所发送的数据分组出现了差错，于是可以不等超时计时器超时就立刻开始重传，具体收到几个重复确认就立刻重传，根据具体实现决定。

![[36 传输异常.png]]

如果收到这4个重复的确认并不会触发发送立刻重传，一段时间后。超时计时器超时，也会将发送窗口内以发送过的这些数据分组全部重传。
![[37 传输异常.png]]
### 窗口值过小
若$W_{TX}$超过取值范围，例如$W_{TX}$=8，会出现什么情况？
![[38 窗口值过小.png]]
【例题】数据链路层使用后退N帧(GBN)协议,发送方已经发送了编号为0~7的帧。当计时器超时时，若发送方只收到0、2. 3号帧的确认，则发送方需要重发的帧数是（C）
A.2
B.3
C.4
D.5
(1) "发送方只收到0、2、3号帧的确认"表明接收方正确接收了0~3号帧，并针对它们中的每一个发送了确认帧，只不过针对1号帧的确认帧丢失了（这是题目中的陷阱，但又没有相应的选项，所以迷惑性并不是很大）; 
(2)截止到计时器超时，发送方只收到了针对0~ 3号帧的确认，而发送方之前已经发送了0~7号帧，因此应该从4号帧开始重传，即重传之前已经发送过的4、5、6、7号帧，共计重传4个帧。

### 总结
![[39 GBN发送.png]]
![[40 GBN接收.png]]
-   回退N帧协议在流水线传输的基础上利用发送窗口来限制发送方连续发送数据分组的数量，是一种连续ARQ协议。
-   在协议的工作过程中发送窗口和接收窗口不断向前滑动，因此这类协议又称为滑动窗口协议。
-   由于回退N帧协议的特性，当通信线路质量不好时，其信道利用率并不比停止-等待协议高。

## 3. 选择重传协议（SR）
回退N帧协议的接收窗口尺寸$W_{RX}$只能等于1,因此接收方只能按序接收正确到达的数据分组。
- 一个数据分组的误码就会导致其后续多个数据分组不能被接收方按序接收而丢弃(尽管它们无乱序和误码)。这必然会造成发送方对这些数据分组的超时重传，显然这是对通信资源的极大浪费。为了 进一步提高性能，可设法只重传出现误码的数据分组。
- 因此，接收窗口的尺寸$W_{RX}$不应再等于1 (**而应大于1**)，以便接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组，等到所缺分组收齐后再一并送交上层。 
- 这就是选择重传协议。
![[41 SR WT.png]]
![[42 SR WR.png]]
![[43 SR 发送.png]]
![[44 SR接收.png]]

# 八. 点对点协议(PPP)
## 1. 协议
-   **点对点协议**（Point-to-Point Protocol）是目前使用最广泛的点对点数据链路层协议。
-   PPP协议是因特网工程任务组IEIF在1992年制定的。
-   经过1993年和1994年的修订，现在的PPP协议已成为因特网的正式标准`[RFC1661，RFC1662]`。
-   数据链路层使用的一种协议，它的特点是：简单；**只检测差错**，而不是纠正差错；不使用序号，也不进行流量控制；可同时支持多种网络层协议。

![[45 PPP 协议.png]]

PPPoE 是为宽带上网的主机使用的链路层协议。
PPP协议为在点对点链路传输各种协议数据报提供了一个标准方法，主要由以下三部分构成:
1. 对各种协议数据报的封装方法(封装成帧)；
2. 链路控制协议LCP，用于建立、配置以及测试数据链路的连接；
3. 一套网络控制协议NCPs，其中的每一个协议支持不同的网络层协议。
![[46 PPP 协议组成.png]]

## 2. 帧格式
必须规定特殊的字符作为帧定界符。
![[47 帧格式.png]]
-   **标志(Flag) 字段** :  PPP帧的定界符,取值为0x7E。
-   **地址(Address) 字段** : 取值为0xFF,预留(目前没有什么作用)
-   **控制(Control) 字段** : 取值为0x03,预留(目前没有什么作用)
-   **协议(Protocol) 字段** : 指明帧的数据部分送交哪个协议处理。
	-  取值0x0021表示:帧的数据部分为IP数据报；
	-  取值0xC021表示:帧的数据部分为LCP分组；
	-  取值0x8021表示:帧的数据部分为NCP分组；
-   **帧检验序列(Frame Check Sequence)字段** : CRC计算出的校验位。
![[48 三种PPP帧.png]]

## 3. 透明传输
必须保证数据传输的透明性，实现透明传输的方法。
-   面向字节的异步链路：字节填充法（插入“转义字符”）。
![[49 字节填充.png]]
发送方的处理:
- 出现的每一个`7E` (PPP帧的定界符)字节转变成2字节序列(`7D`,`5E`)。
- 出现的每一个`7D` (转义字符)字节转变成2字节序列(`7D`,`5D`) 。
- 出现的每一个ASCII码控制字符(数值小于`0x20`的字符) ,则在该字符前面插入一个`7D`字节，同时将该字符的编码加上`0x20`。
- 接收方的处理:进行**反变换**即可恢复出原来的帧的数据部分。
![[50 bit填充.png]]
-   面向比特的同步链路：比特填充法（插入“比特0”）。
发送方的处理:
- 对帧的数据部分进行扫描(一般由硬件实现)。只要发现5个连续的比特1，则立即填充1个比特0。
接收方的处理:
- 对帧的数据部分进行扫描(一般由硬件实现)。只要发现5个连续的比特1，就把其后的1个比特0删除。

## 4. 差错控制
能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。
![[51 FCS.png]]

## 5. 工作状态
-   当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
-   PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
-   这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机
-   分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
-   通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层。

![[52 PPP工作状态.png]]
可见，PPP 协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容。