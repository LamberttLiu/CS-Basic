#计算机网络 
# 十. 路由信息协议RIP
## 路由信息协议RIP
**路由信息协议**RIP(Routing Information Protocol)是内部网关协议IGP中最先得到广泛使用的协议之一，其相关标准文档为RFC 1058。  

RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录。  这是一组距离，称为“**距离向量**D-V(Distance-Vector)" 。

**RIP使用跳数(Hop Count)作为度量(Metric)来衡量到达目的网络的距离**。
- 路由器到**直连网络**的距离定义为1。
- 路由器到**非直连网络**的距离定义为所经过的路由器数加1。  
- 允许一条路径最多只能包含15个路由器。 “距离”等于16时相当于不可达。

> **RIP，实现简单，开销较小。只适用于小型互联网**。

![[69 RIP跳数.png]]
RIP认为好的路由就是 “**距离短**”的路由，也就是所通过路由器数量最少的路由。
![[70 路由结构.png]]
RIP认为R1到R5的好路由是：R1  → R4 →  R5。

当到达同一目的网络有多条 “距离相等”的路由时，可以进行等价负载均衡。
![[71 路由结构.png]]

## RIP包含三个要点：
1. **和谁交换信息** —— 仅和**相邻路由器**交换信息
2. **交换**什么信息 —— 自己的**路由表**
3. 何时**交换信息** —— **周期性交换**(例如每30秒)  

![[72 RIP.png]]

## RIP的基本工作过程
通过路由表交换信息，最终每个路由表
![[73 RIP的交换结果.png]]

①路由器刚开始工作时，只知道自己到直连网络的距离为1。
②每个路由器仅和相邻路由器周期性地交换并更新路由信息。
③若干次交换和更新后，每个路由器都知道到达本AS内各网络的最短距离和下一跳地址，称为收敛。

## RIP的路由条目的更新规则
- 发现了新的网络，添加；
- 到达目的网络，相同下一跳，最新消息，更新；
- 到达目的网络，不同下一跳，新路由优势，更新；
- 到达目的网络，不同下一跳，新路由劣势，不更新；
- 到达目的网络，不同下一跳， 等价负载均衡。

**场景1**  
![[74 路由更新规则.png]]

1. 路由器C的表到达各目的网络的下一条都**记为问号**，可以理解为路由器D并不需要**关心路由器C的这些内容**。
2. 假设路由器C的RIP更新报文**发送周期到了**，则路由器C将自己路由表中的相关路由信息封装到**RIP更新报文**中发送给路由器D。

![[75 路由更新场景.png]]
3. 路由器C能到达这些网络，说明路由器C的相邻路由器也能到达，只是比路由器C的距离大1，于是根据距离的对比，路由器D更新自己的路由表。


![[76 路由更新场景.png]]  
**场景2**

![[77 路由更新场景.png]]
## RIP存在“坏消息传播得慢”的问题

![[78 故障传播慢.png]]  
![[79 故障传播慢.png]]  
![[80 故障传播慢.png]]

## 解决方法
“坏消息传播得慢”又称为**路由环路**或**距离无穷计数**问题，这是距离向量算法的一个固有问题。可以采取多种措施减少出现该问题的概率或减小该问题带来的危害。
-   限制最大路径距离为15 (16表示不可达)。
-   当**路由表发生变化**时就立即发送**更新报文**（即“触发更新”），而不仅是周期性发送。
-   让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送（即“水平分割”）。  

![[81 水平分割.png]]  

# 十一. 开放最短路径优先OSPF

> **注意**：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

**开放最短路径优先OSPF**(Open Shortest Path First)，是为克服RIP的缺点在1989年开发出来的。“开放”表明OSPF协议不是受某一家厂商控制，而是公开发表的。

- “最短路径优先”因为使用了Djkstra提出的**最短路径算法SPF**。
- OSPF是基于**链路状态**的， 而不像RIP那样是基于距离向量的。
- OSPF采用**SPF算法**计算路由， 从算法上保证了不会产生路由环路。
- OSPF不限制网络规模， 更新效率高，收敛速度快。

> 链路状态是指本路由器都和哪些路由器相邻， 以及相应链路的“代价”(cost)。“代价” 用来表示费用、距离、时延、带宽，等等。这些都由网络管理人员来决定。

思科路由器中OSPF计算代价的方法：100Mbps /链路带宽，计算结果小于1的值仍记为1；大于1且有小数的，舍去小数。
![[82 OSPF链路状态.png]]

## 问候(Hello) 分组
OSPF相邻路由器之间通过**交互问候 (Hello) 分组**，建立和维护**邻居关系**。
- Hello分组封装在IP数据报中， 发往组播地址224.0.0.5；
![[83 hello分组.png]]
- 发送周期为10秒；
- 40秒未收到来自邻居路由器的Hello分组， 则认为该邻居路由器不可达。

![[84 邻居关系维护.png]]
IP数据报首部中协议号字段的取值应为89，来表明IP数据报的数据载荷为OSPF分组。

## 发送链路状态通告LSA
-   使用OSPF的每个路由器都会产生**链路状态通告LSA**（Link State Advertisement），LSA中包含以下内容：
	- 直连网络的链路状态信息；
	- 邻居路由器的链路状态信息；
-   LSA被封装在**链路状态更新分组LSU**中，采用**洪泛法**发送。

![[85 LSA.png]]
洪泛法有点类似于广播，就是从一个接口进来，从其他剩余所有接口出去。

链路状态数据库同步：
-   使用OSPF的每个路由器都有一个链路状态数据库LSDB，用于存储LSA。
-   通过各路由器洪泛发送封装有自己LSA的LSU分组，各路由器的LSDB最终将达到一致。  

![[86 LSA.png]]  
**使用SPF算法计算出各自路由器到达其他路由器的最短路径**。  
使用OSPF的各路由器基于LSDB进行最短路径优先SPF计算，构建出各自到达其他各路由器的最短路径，即构建各自的路由表。  
![[87 LSDB.png]]


## OSPF五种分组类型
1. 类型1，**问候(Hello)分组**，用来发现和维护邻居路由器的可达性。
2. 类型2，**数据库描述(Database Description)分组**，向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
3. 类型3， **链路状态请求(Link State Request)分组**，向邻居路由器请求发送某些链路状态项目的详细信息。
4. 类型4，**链路状态更新(Link State Update)分组**，路由器使用这种分组将其链路状态进行洪泛发送，即用洪泛法对全网更新链路状态。
5. 类型5， **链路状态确认(Link State Acknowledgment)分组**，这是对链路状态更新分组的确认分组。

## OSPF的基本工作过程
![[88 OSPF工作流程.png]]

OSPF在多点接入网络中路由器邻居关系建立，如果不采用其他机制，将会产生大量的多播分组。

OSPF在多点接入网络中路由器邻居关系的建立：
1. 选举指定路由器DR(designated router)和备用的指定路由器BDR(backup designated router)；
2. 所有的非DR/BDR只与DR/BDR建立邻居关系；
3. 非DR/BDR之间通过DR/BDR交换信息。
![[89 OSPF.png]]
![[90 邻居关系数量.png]]

> 若DR出现问题，则由BDR顶替DR。

## 区域（Area）
为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做**区域**（Area）。  

-   在该自治系统内，所有路由器都使用OSPF协议，OSPF将该自治系统再划分成4个更小的区域；
-   每个区域都有一个32比特的区域标识符；
-   主干区域的区域标识符必须为0，主干区域用于连通其他区域；
-   其他区域的区域标识符不能为0且不相同；
-   每个区域一般不应包含路由器超过200个；
-   划分区域的好处就是，**利用洪泛法交换链路状态信息局限于每一个区域而不是自治系统，这样减少整个网络上的通信量**。

![[91 区域.png]]

- **区域内路由器**IR(internal router): R1, R2, R8, A9；
- **主干路由器**BBR(backbone router): R3, R4, R5, R6, R7；
- **区域边界路由器**ABR(area border router): R3, R4, R7；
- **自治系统边界路由器**ASBR(AS border router): R6。


# 十二. 边界网关协议BGP
BGP（Border Gateway Protocol） 是**不同自治系统的路由器之间**交换路由信息的协议。

- **内部网关协议IGP** (例如路由信息协议RIP或开放最短路径优先OSPF)
	- 设法使分组在一个自治系统内尽可能有效地从源网络传输到目的网络；
	- 无需考虑自治系统外部其他方面的策略。
- **外部网关协议**EGP (例如边界网关协议BGP)
	- 在不同自治系统内,度量路由的“代价”(距离, 带宽,费用等)可能不同。

因此，对于自治系统之间的路由选择，**使用“代价”作为度量来寻找最佳路由是不行的**。  
![[92 标准不同，无法找到合适路由.png]]
## BGP发言人
在配置BGP时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP发言人”。
不同自治系统的BGP发言人要交换路由信息，首先必须**建立TCP连接，端口号为179**。
- 在此TCP连接上交换BGP报文以建立BGP会话；
- 利用BGP会话交换路由信息(例如，增加新的路由，或撤销过时的路由，以及报告出错的情况等)；
- 使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的邻站(neighbor) 或对等站(peer)。
BGP发言人除了运行BGP外，还必须运行自己所在自治系统所使用的内部网关协议IGP，例如OSPF或RIP。

![[93 BGP.png]]  
BGP发言人交换网络可达性的信息（要到达某个网络所要经过的一系列自治系统）。  
当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就根据所采用的策略从收到的路由信息中找出到达各自治系统的较好的路由。也就是构造出树形结构、不存在回路的自治系统连通图。  

![[94 BGP的逻辑结构.png]]
## BGP适用于多级结构的因特网
![[95 多级AS.png]]
## 四类报文
BGP-4有以下四种报文
- **OPEN(打开)报文**：用来与相邻的另一个BGP发言人建立关系，使通信初始化。
- **UPDATE(更新)报文**：用来通告某一路由的信息， 以及列出要撤销的多条路由。
- **KEEPALIVE(保活)报文**：用来周期性地证实邻站的连通性。
- **NOTIFICATION(通知)报文**：用来发送检测到的差错。

## 总结
三种类型的报文格式使用IP格式进行封装。  
![[96 RIP OSPF BGP的封装.png]]
