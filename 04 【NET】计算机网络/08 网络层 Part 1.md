#计算机网络 

# 一. 网络层功能概述

> 网络层的主要任务是**实现网络互连**，进而**实现数据包在各网络之间的传输**。

![[01 IP层.png]]
就想上面的图这样，对于这些异构型网络N1~N7如果只是需要各自内部通信，他们只要实现各自的物理层和数据链路层即可。

但是，如果要将这些**异构型网络互连起来**，形成一个更大的互联网，就需要实现网络层设备路由器，有时为了简单起见，可以做抽象处理，不用画出这些网络内部具体的结构，图中`N1~N7`，而将他们看做是一条链路即可。

【重点】**网络层需要解决什么问题**？

## 1. 网络层向运输层提供怎样的服务（“可靠传输”还是“不可靠传输”）
在数据链路层提及可靠传输，网络层对以下的**分组丢失**、**分组失序**、**分组重复**的传输错误采取措施，使得接收方能正确接受发送方发送的数据，就是**可靠传输**，反之，如果什么措施也不采取，则是**不可靠传输**。

> **网络层是不提供可靠传输服务的**。

## 2. 网络层寻址问题

![[02 网络寻址.png]]

## 3. 路由选择问题

![[03 路由选择.png]]
**问题**：路由器收到数据后，是依据什么来决定将数据包从自己的哪个接口转发出去？

依据数据包的目的地址和路由器中的路由表。但在实际当中，路由器是怎样知道这些路由记录？

-   由用户或**网络管理员进行人工配置**，这种方法只适用于规模较小且网络拓扑不改变的小型互联网。
-   另一种是实现各种**路由选择协议**，由路由器执行路由选择协议中所规定的路由选择算法，而自动得出路由表中的路由记录，这种方法更适合规模较大且网络拓扑经常改变的大型互联网。


# 二. 数据报和虚电路
-   在计算机网络领域，网络层应该向运输层提供怎样的服务（“**面向连接**”还是“**无连接**”）曾引起了长期的争论。
-   争论焦点的实质就是：**在计算机通信中，可靠交付应当由谁来负责**？是**网络**还是**端系统**？

## 面向连接的数据报服务
**一种观点：让网络负责可靠交付**
-   这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用**面向连接**的通信方式。
-   通信之前先建立**虚电路** (Virtual Circuit)，以保证双方通信所需的一切网络资源。
-   如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。
![[04 虚电路.png]]
**发送方** 发送给 **接收方** 的所有分组都沿着同一条虚电路传送。
-  虚电路表示这只是一条**逻辑上的连接**，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
- 请注意，电路交换的**电话通信**是先建立了一条**真正的连接**。
- 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。

## 无连接的数据报服务
**另一种观点：网络提供数据报服务**
-   互联网的先驱者提出了一种崭新的网络设计思路。
-   网络层向上只提供简单灵活的、**无连接的**、**尽最大努力交付**的**数据报服务**。
-   网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
-   **网络层不提供服务质量的承诺**。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。
![[05 分组转发.png]]

**发送方** 发送给 **接收方** 的分组可能沿着不同路径传送， **尽最大努力交付**。
- 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的**主机中的运输层负责可靠交付（包括差错处理、流量控制等）** 。
- 采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用。
- 互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。


## 虚电路服务与数据报服务的对比

| **对比的方面**                 | **虚电路服务**                                     | **数据报服务**                                         |
| ------------------------------ | -------------------------------------------------- | ------------------------------------------------------ |
| **思路**                       | **可靠通信应当由网络来保证**                       | **可靠通信应当由用户主机来保证**                       |
| **连接的建立**                 | **必须有**                                         | **不需要**                                             |
| **终点地址**                   | **仅在连接建立阶段使用，每个分组使用短的虚电路号** | **每个分组都有终点的完整地址**                         |
| **分组的转发**                 | **属于同一条虚电路的分组均按照同一路由进行转发**   | **每个分组独立选择路由进行转发**                       |
| **当结点出故障时**             | **所有通过出故障的结点的虚电路均不能工作**         | **出故障的结点可能会丢失分组，一些路由可能会发生变化** |
| **分组的顺序**                 | **总是按发送顺序到达终点**                         | **到达终点时不一定按发送顺序**                         |
| **端到端的差错处理和流量控制** | **可以由网络负责，也可以由用户主机负责**           | **由用户主机负责**                                     |

# 三. IPv4地址

在TCP/IP体系中， IP地址是一个最基本的概念，我们必须把它弄清楚。
IPv4地址就是给因特网(Internet)上的每一 台主机(或路由器)的每一 个接口分配一 个在全世界范围内是唯一的32比特的标识符。

IP地址由因特网名字和数字分配机构ICANN(Intermet Corporation for Assigned Names and Numbers)进行分配。我国用户可向亚太网络信息中心APNIC(Asia Pacific Network Information Center)申请IP地址，需要缴费。

2011年2月3日，互联网号码分配管理局IANA (由ICANN行使职能)宣布，IPv4地址已经分配完毕。我国在2014至2015年也逐步停止了向新用户和应用分配IPv4地址。同时全面开展商用部署IPv6。
## 发展阶段
IPv4地址的编址方法经历了如下三个历史阶段:
![[06 IP发展的三个阶段.png]]

32比特的IPv4地址不方便阅读、记录以及输入等,因此IPv4地址采用点分十进制表示方法以方便用户使用。
![[07 点分十进制.png]]

## IPv4 地址分类
**注意**：
1. 只有A类、B类和C类地址可分配给网络中的主机或路由器的各接口。
2. 主机号为“全0”的地址是网络地址，不能分配给主机或路由器的各接口。
3. 主机号为“全1”的地址是广播地址，不能分配给主机或路由器的各接口。
![[08 5类IP地址.png]]

-   每一类地址都由两个固定长度的字段组成，其中一个字段是**网络号 net-id**，它标志主机（或路由器）所连接到的网络，而另一个字段则是**主机号 host-id**，它标志该主机（或路由器）。
-   主机号，在它前面的网络号所指明的网络范围内必须是唯一的。
-   由此可见，**一个 IP 地址在整个互联网范围内是唯一的**。

### A类地址
**最小网络号0，保留不指派**。
第一个可指派的网络号为1，网络地址为1.0.0.0。
**最大网络号127,作为本地环回测试地址，不指派**。

最小的**本地环回测试**地址为127.0.0.1。
最大的**本地环回测试**地址为127.255.255.254。
最后，一个可指派的网络号为126，网络地址为126.0.0.0，可指派的网络数量为$2^{8-1} - 2 = 126$ （减2的原因是除去最小网0，以及最大网络号127）。
![[09 A类地址.png]]
每个网络中可分配的IP地址数量为$2^{24}- 2 = 16777214$ (减2的原因是除去主机号为全0的网络地址和全1的广播地址)。

### B类地址
最小网络号也是第一个可指派的网络号128.0，网络地址为128.0.0.0。
最大网络号也是最后一一个可指派的网络号191.255，网络地址为191.255.0.0。
可指派的网络数量为$2^{16-2} = 16384$ ，每个网络中可分配的IP地址数量为$2^{16} - 2 = 65534$  (减2的原因是除去主机号为全0的网络地址和全1的广播地址)。
![[10 B类地址.png]]
### C类地址
最小网络号也是第一个可指派的网络号192.0.0，网络地址为192.0.0.0
最大网络号也是最后一个可指派的网络号223.255.255，网络地址为223.255.255.0
可指派的网络数量为$2^{24-3}=2097152$
每个网络中可分配的IP地址数量为$2^8 - 2 = 254$ (减2的原因是除去主机号全为0的网络地址和全1的广播地址）。
![[11 C类地址.png]]
1. 根据地址左起第一个十进制数的值，可以判断出网络类别(小于127的为A类, 128~191的为B类，192~223的为C类) ;
2. 根据网络类别，就可找出地址中的网络号部分和主机号部分(A类地址网络号为左起第1个字节，B类地址网络号为左起前两个字节，C类地址网络号为左起前三个字节) ;
3. 以下三种情况的地址不能指派给主机或路由器接口:
	1. A类网络号0和127；
	2. 主机号为“全0”，这是网络地址；
	3. 主机号为“全1"，这是广播地址。

**总结IP地址的指派范围**：
![[12 IP指派范围.png]]
**一般不使用的特殊的 IP 地址**：
![[13 特殊IP地址.png]]

## IP 地址的一些重要特点

1. IP 地址是一种分等级的地址结构
分两个等级的好处是：
-   **第一**，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。
-   **第二**，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。

2. 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口
-   当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为**多归属主机** (multihomed host)。
-   由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此**一个路由器至少应当有两个不同的 IP 地址**。

3.用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。

4.所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。

# 四. IPv4子网
在 ARPANET 的早期，IP 地址的设计确实不够合理：
-   IP 地址空间的利用率有时很低。
-   给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。
-   两级的 IP 地址不够灵活。

所以就有了划分子网的工具：**子网掩码**
-   从 1985 年起在 IP 地址中又增加了一个“**子网号字段**”，使两级的 IP 地址变成为**三级的 IP 地址**。
-   这种做法叫做**划分子网** (subnetting) 。
-   划分子网已成为互联网的正式标准协议。

## 划分方式
基本思路
-   划分子网纯属一个**单位内部的事情**。单位对外仍然表现为没有划分子网的网络。
-   从主机号**借用**若干个位作为**子网号** subnet-id，而主机号 host-id 也就相应减少了若干个位。
![[14 子网划分.png]]
-   凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的**目的网络号** net-id，先找到连接在本单位网络上的路由器。
-   然后**此路由器**在收到 IP 数据报后，再按**目的网络号** net-id 和**子网号** subnet-id 找到目的子网。
-   最后就将 IP 数据报直接交付目的主机。

划分为三个子网后对外仍是一个网络：
![[15 子网内部.png]]
-   **优点**
    1.  减少了 IP 地址的浪费
    2.  使网络的组织更加灵活
    3.  更便于维护和管理
-   **划分子网纯属一个单位内部的事情，对外部网络透明**，对外仍然表现为没有划分子网的一个网络。

## 子网掩码
![[16 子网掩码.png]]
32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号。
- 子网掩码使用连续的比特1来对应网络号和子网号。
- 子网掩码使用连续的比特0来对应主机号。
- 将划分子网的IPv4地址与其相应的子网掩码进行逻辑与运算就可得到IPv4地址所在子网的网络地址。

> **(IP 地址) AND (子网掩码) = 网络地址**

- 已知某个网络的地址为`218.75.230.0`,使用子网掩码`255.255.255.128`对其进行子网划分，请给出划分细节。
![[17 子网掩码的例子.png]]
![[18 子网掩码的例子.png]]

- 已知某个网络的地址为`218.75.230.0`,使用子网掩码`255.255.255.192`对其进行子网划分，请给出划分细节。
![[19 子网掩码的例子.png]]

默认子网掩码，是指在未划分子网情况下使用的子网掩码。
![[20 默认子网掩码.png]]
- 为新增网络申请新的网络号会带来以下弊端:
	1. 需要等待时间和花费更多的费用。
	2. 会增加其他路由器中路由表记录的数量。
	3. 浪费原有网络号中剩余的大量IP地址

可以从主机号部分借用一部分比特作为子网号，32比特的子网掩码可以表明分类IP地址的主机号部分被借用了几个比特作为子网号。

- **子网掩码使用连续的比特1来对应网络号和子网号**：
	1. 子网掩码使用连续的比特0来对应主机号。
	2. 划分子网的IPv4地址与其相应的子网掩码进行逻辑与运算就可得到IPv4地址所在子网的网络地址。

- 给定一个分类的IP地址和其相应的子网掩码，就可知道子网划分的细节:
	1. 划分出的子网数量。
	2. 每个子网可分配的IP地址数量。
	3. 每个子网的网络地址和广播地址。
	4. 每个子网可分配的最小和最大地址。

-  **子网掩码**是一个网络或一个子网的重要属性。
-   路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的**子网掩码告诉相邻路由器**。
-   路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。
-   若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。

# 五. 无分类编址的IPv4地址
## 为什么使用无分类编址?
**无分类域间路由选择 CIDR** (Classless Inter-Domain Routing)。
1. 划分子网在一定程度上缓解了因特网在发展中遇到的困难，但是数量巨大的C类网因为其地址空间太小并没有得到充分使用，而因特网的IP地址仍在加速消耗，整个IPv4地址空间面临全部耗尽的威胁。
2. 为此，因特网工程任务组IETF又提出了采用无分类编址的方法来解决IP地址紧张的问题,同时还专门成立IPv6工作组负责研究新版本IP以彻底解决IP地址耗尽问题。
3. 1993年，IETF发布了无分类域间路由选择CIDR(Classless Inter- Domain Routing)的RFC文档: RFC 1517~1519和1520。
4. CIDR消除 了传统的A类、B类和C类地址，以及划分子网的概念;
5. CIDR可以更加有效地分配IPv4的地址空间，并且可以在新的IPv6使用之前允许因特网的规模继续增长。

**CIDR 最主要的特点**
-   CIDR使用各种长度的“**网络前缀**”(network-prefix)来代替分类地址中的网络号和子网号。
-   **IP 地址从三级编址（使用子网掩码）又回到了两级编址**。

## 如何使用无分类编址?
CIDR使用“斜线记法”，或称CIDR记法。即在IPv4地址后面加上斜线"/" ，在斜线后面写上网络前缀所占的比特数量。
![[21 CIDR.png]]
CIDR实际上是将网络前缀都相同的连续的IP地址组成一个“CIDR地址块”。
我们只要知道CIDR地址块中的任何一个地址,就可以知道该地址块的全部细节:
1. 地址块的最小地址。
2. 地址块的最大地址。
3. 地址块中的地址数量。
4. 地址块聚合某类网络(A类. B类或C类)的数量。
5. 地址掩码 (也可继续称为子网掩码)。

## CIDR举例
请给出CIDR地址块$128.14.35.7/20$的全部细节(最小地址，最大地址，地址数量,聚合C类网数量，地址掩码)。
![[22 CIDR举例.png]]
网络前缀越长，地址块越小，路由越具体;
若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条,这称为最长前缀匹配，因为这样的路由更具体。
![[23 路由聚合.png]]

# 六. IPv4地址应用规划

给定一个IPv4地址快，如何将其划分成几个更小的地址块，并将这些地址块分配给互联网中不同网络，进而可以给各网络中的主机和路由器接口分配IPv4地址。

## 定长的子网掩码FLSM（Fixed Length Subnet Mask）
定长的子网掩码，使用同一个子网掩码来划分子网子网。
划分方式不灵活：只能划分出$2^n$个子网（n是从主机号部分借用的用来作为子网号的比特数量)
每个子网所分配的IP地址数量相同，容易造成IP地址浪费。

**划分子网的IPv4就是定长的子网掩码**

【举例】假设申请到的C类网络为218.75.230.0,请使用定长的子网掩码给下图所示的小型互联网中的各设备分配IP地址。
![[24 定长子网掩码.png]]

应用需求:将C类网络218.75.230.0划分成5个子网，每个子网上可分配的IP地址数量不得少于各自的需求。
![[25 定长子网掩码.png]]


![[26 定长子网掩码.png]]

通过上面步骤分析，就可以从子网1~~8中任选5个分配给左图中的N1~~N5

**采用定长的子网掩码划分，只能划分出$2^n$个子网，其中n是从主机号部分借用的用来作为子网号的比特数量，每个子网所分配的IP地址数量相同**。
**但是也因为每个子网所分配的IP地址数量相同，不够灵活，容易造成IP地址的浪费**。


## 变长的子网掩码VLSM（Variable Length Subnet Mask）

使用不同的子网掩码来划分子网，子网划分方式灵活：可以按需分配。
每个子网所分配的IP地址数量可以不同，尽可能减少对IP地址的浪费。
**无分类编址的IPv4就是变长的子网掩码**

【举例】假设申请到的C类网络为218.75.230.0/24，请使用变长的子网掩码给下图所示的小型互联网中的各设备分配IP地址。
![[27 变长子网掩码.png]]

![[28 变长子网掩码.png]]

![[29 变长子网掩码.png]]
