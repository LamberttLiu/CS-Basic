#计算机网络 
# 十四. 以太网交换机自学习和转发帧的流程
基础概念：
-   以太网交换机工作在数据链路层(也包括物理层)。
-   以太网交换机收到帧后，在帧交换表中查找帧的目的MAC地址所对应的接口号，然后通过该接口转发帧。
-   以太网交换机是一种即插即用设备,刚.上电启动时其内部的帧交换表是空的。随着网络中各主机间的通信，以太网交换机通过自学习算法自动逐渐建立起帧交换表。

## 自学习和转发帧的例子
以下例子假设各主机知道网络中其他各主机的MAC地址（无需进行ARP）

## A→B
![[127 交换机 A-B.png]]
步骤：
1.  A 先向 B 发送一帧。该帧从接口 1 进入到交换机；
2.  交换机收到帧后，先查找（图中左边）交换表。没有查到应从哪个接口转发这个帧给 B；
3.  交换机把这个帧的源地址 A 和接口 1 写入（图中左边）交换表中；
4.  交换机向除接口 1 以外的所有的接口广播这个帧；
5.  接口 4到接口 2，先查找（图中右边）交换表。没有查到应从哪个接口转发这个帧给 B；
6.  交换机把这个帧的源地址 A 和接口 1 写入（图中右边）交换表中；
7.  除B主机之外与该帧的目的地址不相符，将丢弃该帧；
8.  主机B发现是给自己的帧，接受该帧。

## B→A
![[128 交换机 B-A.png]]
1.  B 向 A 发送一帧。该帧从接口 3 进入到交换机；
2.  交换机收到帧后，先查找（图中左边）交换表。发现（图中左边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口1转发出去。于是就把这个帧传送到接口 1 转发给 A。
3.  主机 A 发现目的地址是它，就接受该帧；
4.  交换机把这个帧的源地址 B 和接口 3 写入（图中左边）交换表中。

## E→A
![[129  交换机 E-A.png]]
1.  E 向 A发送一帧；
2.  交换机收到帧后，先查找（图中右边）交换表。发现（图中右边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口2转发出去。于是就把这个帧传送到接口 2 转发给 接口 4。
3.  交换机把这个帧的源地址 E 和接口 3 写入（图中右边）交换表中；
4.  接口 4 到 左边的交换机，先查找（图中左边）交换表。发现（图中左边）交换表中的 MAC 地址有 A，表明要发送给A的帧应从接口1转发出去。于是就把这个帧传送到接口 1 转发给 A。
5.  交换机把这个帧的源地址 E 和接口 4 写入（图中左边）交换表中；
6.  主机 A 发现目的地址是它，就接受该帧。

## G→A
![[130 交换机 G-A.png]]
主机 A、主机 G、交换机 1的接口 1就共享同一条总线（相当于总线式网络，可以想象成用集线器连接了）
1.  主机 G 发送给 主机 A 一个帧；
2.  主机 A 和 交换机接口 1都能接收到；
3.  主机 A 的网卡收到后，根据帧的目的MAC地址A，就知道是发送给自己的帧，就接受该帧；
4.  交换机 1收到该帧后，首先进行登记工作；
5.  然后交换机 1对该帧进行转发，该帧的MAC地址是A，在（图中左边）交换表查找MAC 地址有 A；
6.  MAC 地址为 A的接口号是1，但是该帧正是从接口 1 进入交换机的，交换机不会再从该接口 1 将帧转发出去，因为这是没有必要，于是丢弃该帧。

随着网络中各主机都发送了帧后，网络中的各交换机就可以学习到各主机的MAC地址，以及它们与自己各接口的对应关系。
![[131 交换机 有效时间.png]]
考虑到可能有时要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目。为此，在交换表中每个项目都设有一定的**有效时间**。**过期的项目就自动被删除**。

**以太网交换机的这种自学习方法使得以太网交换机能够即插即用，不必人工进行配置，因此非常方便。**

## 总结
**交换机自学习和转发帧的步骤归纳**：
![[132 交换机自学习.png]]
- 以太网交换机工作在**数据链路层** (也包括物理层)。
- 以太网交换机收到帧后，在帧交换表中查找帧的**目的MAC地址所对应的接口号**，然后通过该接口转发帧。
- 以太网交换机是一种即插即用设备，刚上电启动时其内部的帧交换表是空的。随着网络中各主机间的通信，以太网交换机**通过自学习算法**自动**逐渐建立起帧交换表**。

- 以太网**交换机自学习和转发帧的流程**:
	1.  收到帧后进行登记。 登记的内容为帧的源MAC地址及进入交换机的接口号；
	2.  根据帧的目的MAC地址和交换机的帧交换表对帧进行转发，有以下三种情况:
		1. **明确转发**:交换机知道应当从哪个(或哪些)接口转发该帧(单播，多播，广播)。
		2. **盲目转发**:交换机不知道应当从哪个端口转发帧，只能将其通过除进入交换机的接口外的其他所有接口转发(也称为泛洪)。
		3. **明确丢弃**: 交换机知道不应该转发该帧，将其丢弃。

-  帧交换表中的**每条记录都有自己的有效时间**， 到期删除。原因如下: 
	1. 交换机的接口改接了另一台主机；
	2. 主机更换了网卡。

# 十五. 以太网交换机的生成树协议STP

## 如何提高以太网的可靠性

![[133 以太网可靠性.png]]
添加冗余链路可以提高以太网的可靠性。
![[134 添加冗余链路.png]]
如何提高以太网的可靠性?
1. 添加冗余链路可以提高以太网的可靠性；
2. 但是， 冗余链路也会带来负面效应一形成网络环路。
3. 网络环路会带来以下问题：
	1. **广播风暴**，大量消耗网络资源，使得网络无法正常转发其他数据帧；
	2. 主机收到重复的广播帧，广播大量消耗主机资源。
	3. 交换机的帧交换表震荡(漂移)。

![[135 网络环路.png]]

## 生成树协议STP

以太网交换机使用**生成树协议STP**(Spanning Tree Protocol)，可以在增加冗余链路来提高网络可靠性的同时又避免网络环路带来的各种问题。
- 不论交换机之间采用怎样的物理连接， 交换机都能够自动计算并构建一个逻辑上没有环路的网络，其逻辑拓扑结构必须是树型的(无逻辑环路) ;
- 最终生成的树型逻辑拓扑要确保连通整个网络；
- 当首次连接交换机或网络物理拓扑发生变化时(有可能是人为改变或故障)，交换机都将进行生成树的重新计算。


-   IEEE 802.1D 标准制定了一个**生成树协议 STP** (Spanning Tree Protocol)。
-   其**要点**是：**不改变**网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是**无环路的树状结构**，从而消除了兜圈子现象。
![[136 生成树STP.png]]

# 十六. 虚拟局域网VLAN

## 为什么要虚拟局域网VLAN
虚拟局域网VLAN概述：
以太网交换机工作在数据链路层 (也包括物理层)，使用一个或多个以太网交换机互连起来的交换式以太网，其所有站点都属于同一个广播域。
随着交换式以太网规模的扩大， 广播域相应扩大。巨大的广 播域会带来很多弊端:
- 广播风暴；
- 难以管理和维护；
- 潜在的安全问题。
![[137 虚拟局域网 VLAN.png]]


广播风暴会浪费网络资源和各主机的CPU资源!网络中会频繁出现广播信息。
1. TCP/IP协议栈中的很多协议都会使用广播：
	1.   地址解析协议ARP (已知IP地址,找出其相应的MAC地址)；
	2.   路由信息协议RIP (一种小型的内部路由协议)；
	3.   动态主机配置协议DHCP (用于自动配置IP地址)。
2. NetBEUI: Widnows下使用的广播型协议。
3. IPX/SPX: Novell网络的协议栈。
4. Apple Talk: Apple公司的网络协议栈。

**分割广播域的方法**：
1. 使用路由器可以隔离广播域，但是路由器的成本较高。
![[138 分割广播域.png]]
2. 为了分割广播域，所以虚拟局域网VLAN技术应运而生。
![[139 分割广播域.png]]
虚拟局域网VLAN(Virtual Local Area Network)是一种将局域网内的设备划分成与物理位置无关的逻辑组的技术，这些逻辑组具有某些共同的需求。

-   利用以太网交换机可以很方便地实现虚拟局域网 VLAN (Virtual LAN)。
-   IEEE 802.1Q 对虚拟局域网 VLAN 的**定义**： **虚拟局域网 VLAN** 是由一些局域网网段构成的**与物理位置无关的逻辑组**，而这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个 VLAN。
-   同一个VLAN内部可以广播通信，不同VLAN不可以广播通信
-   **虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。**
-   由于虚拟局域网是用户和网络资源的逻辑组合，因此可按照需要将有关设备和资源非常方便地重新组合，使用户从不同的服务器或数据库中存取所需的资源。

## 虚拟局域网VLAN的实现机制
虚拟局域网VLAN技术是在交换机上实现的，需要交换机能够实现以下功能
-   能够处理带有VLAN标记的帧——IEEE 802.1 Q帧
-   交换机的各端口可以支持不同的端口类型，不同端口类型的端口对帧的处理方式有所不同
![[140 虚拟局域网实现机制.png]]

VLAN标记的最后12比特称为VLAN标识符VID,它唯一地标志了以太网帧属于哪一一个VLAN。
- VID的取值范围是0~ 4095( $0 - 2^{12} -1$)；
- 0和4095都不用来表示VLAN, 因此用于表示VLAN的VID的有效取值范围是1 ~ 4094。

**802.1Q帧是由交换机来处理的**，而不是用户主机来处理的。
- 当交换机收到普通的以太网帧时， 会将其插入4字节的VLAN标记转变为802.1Q帧， 简称”打标签“；
- 当交换机转发802.1Q帧时， 可能会删除其4字节VLAN标记转变为普通以太网帧，简称“去标签“。


**Access端口**
交换机与用户计算机之间的互连。
![[141 Access端口.png]]
Access端口一般用于连接用户计算机；
Access端口只能属于一个VLAN；
Access端口的PVID值与端口所属VLAN的ID相同(默认为1)
Access端口接收处理方法:
- 一般只接受“未打标签"的普通以太网MAC帧。根据接收帧的端口的PVID给帧“打标签" ，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等。
Access端口发送处理方法:
若帧中的VID与端口的PVID相等，则“去标签”并转发该帧;否则不转发。

![[142 Access端口.png]]

> 同一个VLAN内部可以广播通信，不同VLAN不可以广播通信

**Truck端口**
交换机之间或交换机与路由器之间的互连。

![[143 Truck端口.png]]

**虚拟局域网优点**

虚拟局域网（VLAN）技术具有以下主要优点：
1.  改善了性能
2.  简化了管理
3.  降低了成本
4.  改善了安全性


# 补充：局域网与以太网

## 局域网基本概念

局域网（Local Area Network），简称LAN，某一区域多台计算机互联成计算机组，使用**广播信道**。

- 特点：
1. 覆盖范围小，KM数量级；
2. 专用传输介质，传输速率高（10Mb/s~10Gb/s）
3. 延迟时间短、误码率低、可靠性高。
4. 站点间平等关系
5. 多采用分布式控制和广播式通信，可以进行广播和组播。

局域网主要要素：**网络拓扑、传输介质 与 介质访问控制方法。**
1. **网络拓扑**
![[144 局域网网络拓扑关系.png]]
|     | 优点 | 缺点 |
| --- | ---- | ---- |
|星型	|任意两节点最快两步，速度快，构型简单，便于控制管理	|可靠性差，共享能力差，有单点故障。|
|总线型	|可靠性好，速度快，设备投入少，成本低|	|
|环状	|线路节省	|单点故障，封闭不便于扩充，延时长，效率较低。|
|树状	|易于拓展，易于隔离故障	|容易有单点故障。|


## 以太网
以太网在局域网各种技术中占统治性地位：
1. 造价低廉（以太网网卡不到100块）；
2. 是应用最广泛的局域网技术；
3. 比令牌环网、ATM网便宜，简单；
4. 满足网络速率要求：10Mb/s~10Gb/s.

- 标准：
DIX Ethernet V2 : 第一个局域网产品（以太网）规约。
IEEE 802.3 : IEEE 802委员会802.3工作组制定的第一个IEEE的以太网标准。（帧格式有一丢丢改动）

- 无连接：发送方、接收方之间无“握手过程”；
不可靠：不对发送方的数据帧编号，接收方不向发送方进行确认，差错帧直接丢弃，差错纠错又高层负责。

>**以太网只实现无差错接受，不实现可靠传输**。

- 传输介质：粗同轴电缆→细同轴电缆→双绞线+集线器（无脑转发bit流）
- 物理拓扑：总线型→星型

- 10BASE-T以太网
传送基带信号的双绞线以太网，T表示双绞线，现在10BASE-T采用的是无屏蔽双绞线，传输速率10Mb/s。
1. 物理上星型结构，逻辑上总线结构，每段双绞线100M。
2. 采用曼彻斯特编码。
3. 采用CSMA/CD介质访问控制。

- 适配器与MAC地址
计算机与外界有局域网的连接是通过**通信适配器**的。
网络接口板上面插入一张网卡（NIC，Network interface card）,适配器上装有处理器和储存器（ROM和RAM）,ROM上有计算机硬件地址**MAC地址**。
硬件地址，又称物理地址：每个适配器均有的全球唯一48位二进制地址，前24位代表厂家（由IEEE决定），后24位厂家自己指定，常有6个十六进制表示。例如——$02-60-8c-e4-b1-21$，十六进制最大ff表示$11111111_{(2)}$。

- 以太网MAC帧
![[145 以太网MAC帧.png]]
**CSMA/CD**最小帧长64字节，**MTU**最大传送单元1500字节。**FCS**是CRC检验码。
与IEEE 802.3的区别: 
1. 第三个字段是长度/类型
2. 当长度/类型字段值小于0x0600时，数据字段必须装入LLC子层。

- 高速以太网（传输速率＞10Mb/s）  

